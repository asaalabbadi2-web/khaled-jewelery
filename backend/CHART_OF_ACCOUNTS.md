# دليل شجرة الحسابات - نظام الكتل مع التباعد

## نظام الترقيم (Spaced Block Numbering System)

تم اعتماد نظام **الكتل مع التباعد** لترقيم الحسابات، وهو نظام مرن يسمح بإضافة حسابات جديدة دون إعادة ترقيم.

### قواعد الترقيم:

#### المستويات الخ### مثال 3: إضافة بنك جديد
إذا أردت إضافة بنك رابع:
- **1040** - حساب بنك X
- **1050** - حساب بنك Y
- ...وهكذا

### مثال 4: إضافة حساب مخزون جديد
إذا أردت إضافة نوع مخزون جديد:
- **1295** - مخزون ألماس
- **1300** - مخزون أحجار كريمة (تحذير: سيتعارض مع السلف - استخدم 1295 بدلاً منه)

---

## آلية الترقيم التلقائي للعملاء والموردين

### للعملاء (الآلاف):
- **الترقيم التسلسلي المتصل**: 110000, 110001, 110002, 110003...
- **بدون تباعد**: لا نترك مسافات لأننا نحتاج لآلاف الأرقام
- **التوليد التلقائي**: النظام يقرأ آخر رقم ويضيف 1

### للموردين (المئات):
- **الترقيم التسلسلي**: 21100, 21101, 21102...
- **أو مع تباعد بسيط**: 21100, 21110, 21120... (إذا كان العدد محدوداً)

### الكود المقترح للتطبيق في Flutter/Backend:

```python
# في backend/routes.py أو في ملف منفصل للمساعدة

def get_next_account_number_for_type(parent_account_number, use_spacing=False):
    """
    توليد رقم الحساب التالي لحساب فرعي
    
    Args:
        parent_account_number: رقم الحساب الأب (مثل '1100' للعملاء)
        use_spacing: إذا كان True، استخدم تباعد 10، وإلا استخدم ترقيم متصل
    
    Returns:
        str: رقم الحساب التالي المتاح
    """
    from backend.models import Account
    
    # حدد نطاق البحث بناءً على رقم الأب
    # مثلاً: إذا كان الأب '1100'، ابحث في النطاق 110000-119999
    if len(parent_account_number) <= 4:
        # حسابات العملاء/الموردين التفصيلية (6 خانات)
        start_range = int(parent_account_number + '000')
        end_range = int(parent_account_number + '999')
    else:
        # مستويات أخرى
        start_range = int(parent_account_number + '0')
        end_range = int(parent_account_number + '9')
    
    # ابحث عن آخر رقم حساب في هذا النطاق
    last_account = Account.query.filter(
        Account.account_number >= str(start_range),
        Account.account_number <= str(end_range)
    ).order_by(Account.account_number.desc()).first()
    
    if last_account:
        last_number = int(last_account.account_number)
        if use_spacing:
            # استخدم تباعد 10
            next_number = last_number + 10
        else:
            # ترقيم متصل
            next_number = last_number + 1
    else:
        # أول حساب في هذا النطاق
        next_number = start_range
    
    # تحقق من عدم تجاوز النطاق
    if next_number > end_range:
        raise ValueError(f"تجاوزت السعة المتاحة للحساب {parent_account_number}")
    
    return str(next_number)


# مثال استخدام في API endpoint:
@app.route('/api/accounts/next-number/<parent_number>', methods=['GET'])
def get_next_account_number(parent_number):
    """
    API endpoint للحصول على رقم الحساب التالي المتاح
    """
    try:
        # للعملاء والموردين: بدون تباعد (ترقيم متصل)
        use_spacing = parent_number not in ['1100', '1110', '1120', '211', '212']
        
        next_number = get_next_account_number_for_type(parent_number, use_spacing)
        return jsonify({'next_account_number': next_number}), 200
    except Exception as e:
        return jsonify({'error': str(e)}), 400
```

### في Flutter (api_service.dart):

```dart
Future<String> getNextAccountNumber(String parentAccountNumber) async {
  final response = await http.get(
    Uri.parse('$baseUrl/api/accounts/next-number/$parentAccountNumber'),
  );
  
  if (response.statusCode == 200) {
    final data = json.decode(response.body);
    return data['next_account_number'];
  } else {
    throw Exception('فشل الحصول على رقم الحساب التالي');
  }
}
```

---توى الأول (1-5)**: التصنيفات الرئيسية
2. **المستوى الثاني (10-90)**: المجموعات الفرعية - تباعد 10
3. **المستوى الثالث (100-990)**: الحسابات الفرعية - تباعد 10  
4. **المستوى الرابع (1000-9990)**: الحسابات التفصيلية - تباعد 10
5. **المستوى الخامس (10000+)**: تفاصيل إضافية إذا لزم الأمر

#### التباعد:
- كل حساب يترك مسافة 10 قبل الحساب التالي في نفس المستوى
- هذا يسمح بإضافة 9 حسابات جديدة بين أي حسابين دون إعادة ترقيم
- إذا احتجت أكثر من 9 حسابات، انتقل إلى المستوى الأعلى التالي

---

## شجرة الحسابات الكاملة

### 1 - الأصول

#### 10 - الأصول المتداولة
- **100 - النقدية وما في حكمها**
  - 1000 - صندوق النقدية
  - 1010 - حساب بنك الرياض
  - 1020 - حساب بنك الراجحي
  - 1030 - حساب البنك الأهلي
  - *(يمكن إضافة حسابات بنكية من 1040 حتى 1090)*

- **110 - العملاء**
  - 1100 - عملاء بيع ذهب (حساب تجميعي)
    - **نطاق العملاء التفصيليين: 110000 - 119999** (سعة 10,000 عميل)
    - مثال: 110000 (العميل الأول), 110001 (العميل الثاني), 110002 (العميل الثالث)...
  - 1110 - عملاء صياغة (حساب تجميعي)
    - **نطاق العملاء التفصيليين: 111000 - 111999** (سعة 1,000 عميل)
  - 1120 - عملاء مجوهرات جاهزة (حساب تجميعي)
    - **نطاق العملاء التفصيليين: 112000 - 112999** (سعة 1,000 عميل)
  - *(يمكن إضافة فئات عملاء إضافية: 1130، 1140... حتى 1190)*

- **120 - المخزون**
  - 1200 - مخزون ذهب عيار 24
  - 1210 - مخزون ذهب عيار 22
  - 1220 - مخزون ذهب عيار 21
  - 1230 - مخزون ذهب عيار 18
  - 1240 - مخزون كسر عيار 24
  - 1250 - مخزون كسر عيار 22
  - 1260 - مخزون كسر عيار 21
  - 1270 - مخزون فضة
  - 1280 - مخزون مجوهرات جاهزة
  - 1290 - جسر مشتريات الكسر والتسكير (حساب وسيط)

- **130 - حسابات الموظفين**
  - 1300 - موظفو الإدارة (حساب تجميعي)
    - **نطاق الموظفين التفصيليين: 130000 - 130999** (سعة 1,000 موظف)
    - مثال: 130000 (الموظف الأول), 130001 (الموظف الثاني)...
  - 1310 - موظفو المبيعات (حساب تجميعي)
    - **نطاق الموظفين التفصيليين: 131000 - 131999** (سعة 1,000 موظف)
  - 1320 - موظفو الصيانة (حساب تجميعي)
    - **نطاق الموظفين التفصيليين: 132000 - 132999** (سعة 1,000 موظف)
  - 1330 - موظفو المحاسبة (حساب تجميعي)
    - **نطاق الموظفين التفصيليين: 133000 - 133999** (سعة 1,000 موظف)
  - *(يمكن إضافة أقسام إضافية: 1340، 1350... حتى 1390)*

- **140 - السلف والودائع قصيرة الأجل**
  - *(تم إلغاء نظام سلف الموظفين القديم نهائياً، ولا يتم إنشاء حسابات سلف تلقائياً)*
  - 1410 - تأمينات مستردة
  - 1420 - ودائع قصيرة الأجل

- **150 - مصروفات مدفوعة مقدماً**
- **150 - ضريبة القيمة المضافة (مدينة)**

#### 20 - الأصول الثابتة
- 200 - أثاث وتجهيزات
- 210 - أجهزة ومعدات
- 220 - سيارات
- 230 - مصروفات تحسين محل
- 240 - مجمع إهلاك الأصول الثابتة

---

### 2 - الخصوم (الالتزامات)

#### 21 - التزامات قصيرة الأجل
- 211 - الموردين
- 212 - المصنعين

#### 22 - حسابات دائنة أخرى
- 221 - ضريبة القيمة المضافة - دائنة
- 222 - مستحقات رواتب
- 223 - مستحقات إيجار
- 224 - دفعات مقدمة من العملاء

#### 23 - التزامات طويلة الأجل
- 231 - قروض بنكية طويلة الأجل
- 232 - التزامات أخرى طويلة الأجل

---

### 3 - حقوق الملكية

- 30 - رأس المال
- 31 - المسحوبات الشخصية
- 32 - الأرباح المحتجزة
- 33 - أرباح العام الجاري

---

### 4 - الإيرادات

#### 40 - إيرادات النشاط الأساسي
- 400 - مبيعات ذهب جديد
- 410 - مبيعات كسر ذهب
- 420 - مبيعات صياغة ومصنعية
- 430 - مبيعات مجوهرات جاهزة
- 440 - مبيعات فضة

#### 41 - إيرادات أخرى
- 411 - أرباح بيع أصول ثابتة
- 412 - خصومات مكتسبة
- 413 - إيرادات متنوعة

#### 42 - مردودات ومسموحات المبيعات

---

### 5 - المصروفات

#### 50 - مصاريف تشغيلية
- **500 - الرواتب والأجور**
  - 5000 - رواتب الموظفين
  - 5010 - رواتب الإداريين
  - 5020 - رواتب المحاسبين
  - 5030 - بدلات ومكافآت
- 510 - إيجارات
- 520 - كهرباء ومياه
- 530 - اتصالات وإنترنت
- 540 - صيانة وتشغيل
- 550 - مواد تعبئة وتغليف
- 560 - مصاريف نقل وشحن

#### 51 - مصاريف إدارية وعمومية
- 511 - مستلزمات مكتبية
- 512 - رسوم حكومية وتجديدات
- 513 - استشارات وخدمات مهنية
- 514 - إهلاك الأصول الثابتة

#### 52 - تكلفة البضاعة المباعة
- 521 - تكلفة مبيعات الذهب
- 522 - تكلفة مبيعات المجوهرات الجاهزة
- 523 - تكلفة مبيعات الفضة

---

## أمثلة على إضافة حسابات جديدة

### مثال 1: إضافة عملاء (للأعداد الكبيرة - بالآلاف)

**نظام الترقيم للعملاء يستخدم 6 خانات** لدعم آلاف العملاء:

#### عملاء بيع ذهب (تحت الحساب 1100):
```
1100 - عملاء بيع ذهب (حساب تجميعي - لا يُستخدم مباشرة في القيود)
  ├── 110000 - محمد أحمد السعيد (العميل 1)
  ├── 110001 - فاطمة علي حسن (العميل 2)
  ├── 110002 - خالد سعيد محمود (العميل 3)
  ├── 110003 - نورة عبدالله (العميل 4)
  ...
  ├── 110099 - أحمد خالد (العميل 100)
  ├── 110100 - سارة محمد (العميل 101)
  ...
  ├── 110999 - عبدالرحمن علي (العميل 1000)
  ├── 111000 - ريم أحمد (العميل 1001)
  ...
  └── 119999 - عمر حسن (العميل 10,000)
```

**السعة الإجمالية**: 10,000 عميل لبيع الذهب

#### عملاء الصياغة (تحت الحساب 1110):
```
1110 - عملاء صياغة (حساب تجميعي)
  ├── 111000 - محل الذهب الملكي (عميل صياغة 1)
  ├── 111001 - مشغل النور الذهبي (عميل صياغة 2)
  ├── 111002 - معرض الماس (عميل صياغة 3)
  ...
  └── 111999 - مجوهرات الفخامة (عميل صياغة 1000)
```

**السعة الإجمالية**: 1,000 عميل صياغة

#### كيفية توليد رقم العميل التالي تلقائياً:
```python
def get_next_customer_account_number(category_account='1100'):
    """
    category_account: رقم حساب فئة العملاء (1100, 1110, 1120...)
    يرجع رقم الحساب التالي المتاح للعميل الجديد
    """
    # نطاق البحث: category_account + '000' إلى category_account + '999'
    # مثال: إذا كان category_account = '1100'
    # نطاق البحث: من 110000 إلى 119999
    
    start_range = int(category_account + '000')
    end_range = int(category_account + '999')
    
    # ابحث في قاعدة البيانات عن آخر رقم مستخدم
    last_customer = Account.query.filter(
        Account.account_number >= str(start_range),
        Account.account_number <= str(end_range)
    ).order_by(Account.account_number.desc()).first()
    
    if last_customer:
        # زد 1 على آخر رقم
        next_number = int(last_customer.account_number) + 1
    else:
        # أول عميل في هذه الفئة
        next_number = start_range
    
    return str(next_number)

# مثال استخدام:
# العميل الأول في فئة "عملاء بيع ذهب": 110000
# العميل الثاني: 110001
# العميل المائة: 110099
# العميل الألف: 110999
```

### مثال 2: إضافة موردين (للأعداد الكبيرة)

#### الموردين (تحت الحساب 211):
```
211 - الموردين (حساب تجميعي)
  ├── 21100 - مورد الذهب الخالص (المورد 1)
  ├── 21101 - شركة المعادن الثمينة (المورد 2)
  ├── 21102 - مصفاة الذهب الدولية (المورد 3)
  ...
  └── 21999 - مورد الذهب العالمي (المورد 900)
```

**السعة الإجمالية**: 900 مورد

إذا احتجت المزيد، يمكن إنشاء فئة ثانية:
```
212 - موردين إضافيين (حساب تجميعي)
  ├── 21200 - المورد 901
  ├── 21201 - المورد 902
  ...
  └── 21299 - المورد 1000
```

### مثال 3: إضافة بنك جديد
إذا أردت إضافة بنك رابع:
- **1040** - حساب بنك X
- **1050** - حساب بنك Y
- ...وهكذا

### مثال 3: إضافة مورد
إذا أردت إضافة موردين تفصيليين تحت "الموردين" (211):
- المورد الأول: **2110**
- المورد الثاني: **2120**
- المورد الثالث: **2130**
- ...وهكذا

---

## المزايا

✅ **مرونة عالية**: إضافة حسابات جديدة دون إعادة ترقيم  
✅ **وضوح**: الأرقام تعكس التسلسل الهرمي  
✅ **قابلية التوسع**: يدعم آلاف الحسابات في كل مستوى  
✅ **سهولة الفرز**: الترتيب الرقمي يتوافق مع الترتيب المنطقي  
✅ **توافق**: يعمل مع معظم الأنظمة المحاسبية  

---

## ملاحظات هامة

1. **احترم التباعد**: دائماً اترك مسافة 10 بين الحسابات
2. **الترتيب الهرمي**: يجب إنشاء الحساب الأب قبل الحسابات الفرعية
3. **عدم التكرار**: كل رقم حساب يجب أن يكون فريداً في النظام بأكمله
4. **النطاقات المحجوزة**: 
   - 1000-1999: الأصول التفصيلية
   - 2000-2999: الخصوم التفصيلية  
   - 3000-3999: حقوق الملكية التفصيلية
   - 4000-4999: الإيرادات التفصيلية
   - 5000-5999: المصروفات التفصيلية

5. **نطاقات العملاء والموردين الخاصة** (للأعداد الكبيرة):
   - 110000-119999: عملاء بيع ذهب (10,000 عميل)
   - 111000-111999: عملاء صياغة (1,000 عميل)
   - 112000-112999: عملاء مجوهرات (1,000 عميل)
   - 21100-21999: الموردين (900 مورد)
   - استخدم ترقيم **متصل بدون تباعد** للعملاء والموردين (110000, 110001, 110002...)

6. **التوليد التلقائي**: 
   - يُنصح بإنشاء API endpoint يعطي رقم الحساب التالي تلقائياً
   - راجع قسم "آلية الترقيم التلقائي" في الأعلى

---

**تاريخ آخر تحديث**: 10 أكتوبر 2025  
**الإصدار**: 2.0 - نظام الكتل مع التباعد
