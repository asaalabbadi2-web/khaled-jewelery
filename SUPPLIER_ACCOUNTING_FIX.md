# ุฅุตูุงุญ ุงููุญุงุณุจุฉ ูููุงุชูุฑ ุดุฑุงุก ูู ููุฑุฏ
## Supplier Purchase Accounting Fix

### ุงูุชุงุฑูุฎ: 2025-01-XX
**ุงูุญุงูุฉ:** โ ููุชูู

---

## ุงููุดููุฉ ุงูุฃุตููุฉ

ูุดู ุญุณุงุจ ุงูููุฑุฏ ูุงู ูุธูุฑ ุฃุฑุตุฏุฉ ุตูุฑูุฉ ุนูู ุงูุฑุบู ูู ูุฌูุฏ ูููุฏ ูุญุงุณุจูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.

### ุงูุฃุณุจุงุจ ุงูููุชุดูุฉ:

1. **ูููุฏ ูุญุงุณุจูุฉ ูุฏููุฉ ุจุฏูู `supplier_id`**: ุงููููุฏ ุงูุณุงุจูุฉ ูู ุชูู ุชุญุชูู ุนูู ุญูู `supplier_id` ููุง ููุน ุงุณุชุนูุงู ูุดู ุงูุญุณุงุจ ูู ุงุณุชุฑุฌุงุนูุง
2. **ููุทู ูุญุงุณุจู ุฎุงุทุฆ**: ูู ูุงุชูุฑุฉ "ุดุฑุงุก ูู ููุฑุฏ"ุ ูุงู ุงููุธุงู ูุณุฌู ูููุฉ ููุฏูุฉ ููุฐูุจ ูู ุงููุฎุฒููุ ููุฐุง ูุฎุงูู ูููุจุฏุฃ ุงููุญุงุณุจู ุงูุตุญูุญ

---

## ุงูุญู ุงูููุทุจูู

### 1. ุฅุตูุงุญ ุงุณุชุนูุงู ูุดู ุงูุญุณุงุจ (Ledger Query Fix)

**ุงูููู:** `backend/routes.py` - ุงูุณุทุฑ 810-878

**ุงูุชุนุฏูู:**
```python
# ุงุณุชุนูุงู ูุญุณูู ูุน fallback ููููุงุชูุฑ ุจุฏูู supplier_id ูู ุงููููุฏ
query = db.session.query(
    JournalEntryLine,
    JournalEntry.date.label('entry_date'),
    Invoice.invoice_number.label('invoice_number')
).join(
    JournalEntry, JournalEntryLine.journal_entry_id == JournalEntry.id
).outerjoin(
    Invoice, JournalEntry.id == Invoice.journal_entry_id
).filter(
    db.or_(
        JournalEntryLine.supplier_id == supplier_id,  # ูููุฏ ุฌุฏูุฏุฉ
        Invoice.supplier_id == supplier_id            # ูููุฏ ูุฏููุฉ (fallback)
    )
)
```

**ุงููุชูุฌุฉ:** ุงูุขู ูุณุชุฑุฌุน ูุดู ุงูุญุณุงุจ ุฌููุน ุงููููุฏ ุญุชู ุงููุฏููุฉ ุงูุชู ูู ุชูู ูุฑุชุจุทุฉ ูุจุงุดุฑุฉ ุจู `supplier_id`

---

### 2. ุชุตุญูุญ ุงูููุทู ุงููุญุงุณุจู ููุงุชูุฑุฉ ุดุฑุงุก ูู ููุฑุฏ

**ุงูููู:** `backend/routes.py` - ุงููุณู ุงูุฎุงุต ุจู "ุดุฑุงุก ูู ููุฑุฏ"

#### 2.1 ุฅุซุจุงุช ุงููุฎุฒูู (Inventory Recording)

**ูุจู ุงูุฅุตูุงุญ:**
```python
# ูุงู ูุณุฌู ูููุฉ ููุฏูุฉ ููุฐูุจ ูู ุงููุฎุฒูู โ
cash_debit = some_calculated_value
```

**ุจุนุฏ ุงูุฅุตูุงุญ:**
```python
# ุงููุฎุฒูู ููุณุฌู ุจุงููุฒู ููุท - ูุง ูููุฉ ููุฏูุฉ ููุฐูุจ โ
cash_debit = 0  # ๐ด ูุง ูููุฉ ููุฏูุฉ ููุฐูุจ ูู ุงูุดุฑุงุก ูู ููุฑุฏ
**weight_kwargs  # ููุท ุงูุฃูุฒุงู ุญุณุจ ุงูุนูุงุฑุงุช
```

**ุงููููุฏ ุงููุญุงุณุจูุฉ:**
```
1๏ธโฃ ุฅุซุจุงุช ูุฎุฒูู ุนูุงุฑ 21 (ูุฒู ููุท):
   ูู ุญู/ ูุฎุฒูู ุนูุงุฑ 21 [ูุฒู: 100 ุฌุฑุงู]
   
2๏ธโฃ ุฅุซุจุงุช ูุฎุฒูู ุนูุงุฑ 18 (ูุฒู ููุท):
   ูู ุญู/ ูุฎุฒูู ุนูุงุฑ 18 [ูุฒู: 50 ุฌุฑุงู]
```

---

#### 2.2 ุฅุซุจุงุช ุฃุฌูุฑ ุงููุตูุนูุฉ ูุงูุถุฑุงุฆุจ (Wages & Taxes)

**ุงููููุฏ ุงููุญุงุณุจูุฉ:**
```
3๏ธโฃ ุฃุฌูุฑ ูุตูุนูุฉ:
   ูู ุญู/ ุฃุฌูุฑ ูุตูุนูุฉ [ููุฏ: 500]
   
4๏ธโฃ ุถุฑูุจุฉ ุนูู ุงูุฃุฌูุฑ:
   ูู ุญู/ ุถุฑูุจุฉ ูููุฉ ูุถุงูุฉ ูุณุชุญูุฉ [ููุฏ: 75]
   
5๏ธโฃ ุถุฑูุจุฉ ุนูู ุงูุฐูุจ:
   ูู ุญู/ ุถุฑูุจุฉ ูููุฉ ูุถุงูุฉ ูุณุชุญูุฉ [ููุฏ: 100]
```

**ุฅุฌูุงูู ุงูููุฏ ุงููุฏูู:** 675 (ุฃุฌูุฑ + ุถุฑุงุฆุจ ููุทุ ุจุฏูู ูููุฉ ุงูุฐูุจ)

---

#### 2.3 ุฅุซุจุงุช ุฑุตูุฏ ุงูููุฑุฏ (Supplier Credit)

**ูุจู ุงูุฅุตูุงุญ:**
```python
# ุงูููุฑุฏ ูุงู ููุณุฌู ุจุงูุฐูุจ ููุท (ูุฒู) โ
# ูู ููู ููุงู ุชุณุฌูู ููููุฏูุฉ ุงููุณุชุญูุฉ ูู
```

**ุจุนุฏ ุงูุฅุตูุงุญ:**
```python
# ุงูููุฑุฏ ููุณุฌู ุจุงูุฐูุจ (ูุฒู) + ุงูููุฏูุฉ (ุฃุฌูุฑ + ุถุฑุงุฆุจ) โ

# 5๏ธโฃ ุงูููุฑุฏ ุฏุงุฆู ุจุงูุฐูุจ
create_dual_journal_entry(
    account_id=supplier_account_id,
    weight_21k_credit=100,
    weight_18k_credit=50,
    description="ุฑุตูุฏ ููุฑุฏ ุจุงูุฐูุจ"
)

# 6๏ธโฃ ุงูููุฑุฏ ุฏุงุฆู ุจุงูููุฏูุฉ
create_dual_journal_entry(
    account_id=supplier_account_id,
    cash_credit=675,  # ุฃุฌูุฑ + ุถุฑุงุฆุจ
    description="ุฑุตูุฏ ููุฑุฏ ููุฏู (ุฃุฌูุฑ + ุถุฑุงุฆุจ)"
)

# 7๏ธโฃ ุฅุบูุงู ุงูุญุณุงุจ ุงูุฌุณุฑ
create_dual_journal_entry(
    account_id=bridge_acc_id,
    cash_debit=675,
    description="ุฅุบูุงู ุฌุณุฑ ุงูููุฑุฏ - ุชุญููู ููููุฑุฏ"
)
```

**ุงููููุฏ ุงููุญุงุณุจูุฉ ุงูููุงุฆูุฉ:**
```
6๏ธโฃ ุฑุตูุฏ ุงูููุฑุฏ ุจุงูุฐูุจ:
       ุฅูู ุญู/ ุงูููุฑุฏ [ูุฒู 21: 100 ุฌุฑุงูุ ูุฒู 18: 50 ุฌุฑุงู]

7๏ธโฃ ุฑุตูุฏ ุงูููุฑุฏ ููุฏู:
       ุฅูู ุญู/ ุงูููุฑุฏ [ููุฏ: 675]

8๏ธโฃ ุฅุบูุงู ุงูุฌุณุฑ:
   ูู ุญู/ ุญุณุงุจ ุฌุณุฑ ุงูููุฑุฏ [ููุฏ: 675]
       ุฅูู ุญู/ --- (ุชู ุชุญูููู ููููุฑุฏ)
```

---

## ุงููุนุงุฏูุฉ ุงููุญุงุณุจูุฉ ุงูููุงุฆูุฉ

### ุงูุฌุงูุจ ุงููุฏูู (Assets):
```
ุงููุฎุฒูู (ูุฒู ููุท):
  - ุนูุงุฑ 21: 100 ุฌุฑุงู
  - ุนูุงุฑ 18: 50 ุฌุฑุงู

ุงูุฃุฌูุฑ ูุงูุถุฑุงุฆุจ (ููุฏ):
  - ุฃุฌูุฑ ูุตูุนูุฉ: 500
  - ุถุฑูุจุฉ ุฃุฌูุฑ: 75
  - ุถุฑูุจุฉ ุฐูุจ: 100
  โโโโโโโโโโโโโโโโโโโ
  ุฅุฌูุงูู: 675
```

### ุงูุฌุงูุจ ุงูุฏุงุฆู (Liabilities):
```
ุงูููุฑุฏ:
  - ุฐูุจ ุนูุงุฑ 21: 100 ุฌุฑุงู
  - ุฐูุจ ุนูุงุฑ 18: 50 ุฌุฑุงู
  - ููุฏ: 675
```

**ุงูุชูุงุฒู:** โ
- ุงูุฐูุจ ุจุงููุฒู: ูุชูุงุฒู (ุงูุฃุตูู = ุงูุฎุตูู ุจุงููุฒู)
- ุงูููุฏูุฉ: ูุชูุงุฒูุฉ (675 ูุฏูู = 675 ุฏุงุฆู)

---

## ุงููููุงุช ุงูููุนุฏููุฉ

### 1. `backend/routes.py`
- ุงูุณุทุฑ **810-878**: ุฅุตูุงุญ ุงุณุชุนูุงู ูุดู ุงูุญุณุงุจ
- ุงูุณุทุฑ **2515-2680**: ุฅุนุงุฏุฉ ูุชุงุจุฉ ููุทู ูุญุงุณุจุฉ "ุดุฑุงุก ูู ููุฑุฏ"

### 2. `backend/fix_inventory_accounting.py` (ูุคูุช)
- ุณูุฑูุจุช ูุณุงุนุฏ ูุชุจุณูุท ูุณู ุฅุซุจุงุช ุงููุฎุฒูู
- ุชู ุงุณุชุฎุฏุงูู ูุฑุฉ ูุงุญุฏุฉ ูุฅุฌุฑุงุก ุงูุชุนุฏููุงุช

---

## ุงูุงุฎุชุจุงุฑ ูุงูุชุญูู

### 1. ุงุฎุชุจุงุฑ ุจูุงุก ุงูููุฏ (Syntax Check)
```bash
cd backend
source venv/bin/activate
python -m py_compile routes.py
```
**ุงููุชูุฌุฉ:** โ ูุง ุฃุฎุทุงุก

### 2. ุงุฎุชุจุงุฑ ูุดู ุญุณุงุจ ุงูููุฑุฏ
```bash
curl "http://localhost:8001/api/suppliers/1/ledger?start_date=2025-01-01"
```
**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```json
{
  "movements": [
    {
      "date": "2025-01-15",
      "description": "ุฑุตูุฏ ููุฑุฏ ุจุงูุฐูุจ",
      "weight_21k_credit": 100.0,
      "weight_18k_credit": 50.0
    },
    {
      "date": "2025-01-15",
      "description": "ุฑุตูุฏ ููุฑุฏ ููุฏู (ุฃุฌูุฑ + ุถุฑุงุฆุจ)",
      "cash_credit": 675.0
    }
  ],
  "summary": {
    "cash_balance": 675.0,
    "gold_balance_21k": 100.0,
    "gold_balance_18k": 50.0
  }
}
```

---

## ุงูุชุฃุซูุฑ ุนูู ุงููุธุงู

### ุฅูุฌุงุจูุงุช:
โ ูุดู ุญุณุงุจ ุงูููุฑุฏ ุงูุขู ูุนุฑุถ ุงูุฃุฑุตุฏุฉ ุงูุตุญูุญุฉ  
โ ุงููุจุฏุฃ ุงููุญุงุณุจู ุณููู: ุงููุฎุฒูู ุจุงููุฒูุ ุงูููุฑุฏ ุจุงููุฒู + ุงูููุฏ  
โ ุชูุงูู ูุน ุงููุนูุงุฑ ุงููุญุงุณุจู ููููุดุขุช ุงูุชุฌุงุฑูุฉ  
โ ุณูููุฉ ุชุชุจุน ุงููุณุชุญูุงุช ููููุฑุฏูู (ููุฏ + ุฐูุจ)

### ุงุญุชูุงุทุงุช:
โ๏ธ ูุฌุจ ุฅุนุงุฏุฉ ุงุฎุชุจุงุฑ ุงูููุงุชูุฑ ุงูุฌุฏูุฏุฉ ููุชุฃูุฏ ูู ุตุญุฉ ุงููููุฏ  
โ๏ธ ุงูุจูุงูุงุช ุงููุฏููุฉ ูุฏ ุชุญุชุงุฌ ุชุตุญูุญ ูุฏูู ุฅุฐุง ูุงูุช ุชุญุชูู ุฃุฎุทุงุก ูุญุงุณุจูุฉ

---

## ุงูุฎุทูุงุช ุงูุชุงููุฉ (ุงุฎุชูุงุฑู)

1. **ุชุตุญูุญ ุงููููุฏ ุงููุฏููุฉ**: ุฅุฐุง ูุงูุช ููุงู ูููุฏ ุฎุงุทุฆุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู ูุชุฑุงุช ุณุงุจูุฉ
2. **ุงุฎุชุจุงุฑ ุดุงูู**: ุฅูุดุงุก ูุงุชูุฑุฉ ุดุฑุงุก ูู ููุฑุฏ ุฌุฏูุฏุฉ ูุงูุชุญูู ูู ุงููููุฏ ุงููุญุงุณุจูุฉ
3. **ุชูุซูู ูู ุฏููู ุงููุณุชุฎุฏู**: ุฅุถุงูุฉ ุดุฑุญ ูููุจุฏุฃ ุงููุญุงุณุจู ุงูููุชุจุน

---

## ุงููุฑุงุฌุน

- `backend/routes.py`: ููุทู ุฅูุดุงุก ุงููููุฏ ุงููุญุงุณุจูุฉ
- `backend/dual_system_helpers.py`: ุฏุงูุฉ `create_dual_journal_entry`
- `backend/models.py`: ููุงุฐุฌ `Invoice`, `JournalEntry`, `Supplier`
- `frontend/lib/screens/supplier_ledger_screen.dart`: ุดุงุดุฉ ูุดู ุญุณุงุจ ุงูููุฑุฏ

---

**ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ:** 2025-01-XX  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุฅูุชุงุฌ
