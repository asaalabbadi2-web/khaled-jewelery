# ููุฒุงุช ูุงุชูุฑุฉ ุดุฑุงุก ุงููุณุฑ - Scrap Purchase Invoice Features

## ๐ ูุธุฑุฉ ุนุงูุฉ
ุชู ุชุทููุฑ ุดุงุดุฉ **ูุงุชูุฑุฉ ุดุฑุงุก ุงููุณุฑ** (`scrap_purchase_invoice_screen.dart`) ุจููุฒุงุช ูุชูุฏูุฉ ูุชูุซูู ูุชูููู ุนูููุงุช ุดุฑุงุก ุงูุฐูุจ ุงููุณุชุนูู ูุงููุณุฑ.

---

## โจ ุงูููุฒุงุช ุงูุฑุฆูุณูุฉ

### 1๏ธโฃ ูุธุงู ุงูุชุญูู ูู ุงููููุฉ (KYC)
ุนูุฏ ุฅุถุงูุฉ ุนููู ุฌุฏูุฏุ ูุชู ุฌูุน ุงูุจูุงูุงุช ุงูุชุงููุฉ:

#### ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ:
- **ุงูุงุณู** (name)
- **ุฑูู ุงููุงุชู** (phone)
- **ุงูุนููุงู** (address)

#### ุจูุงูุงุช ุงูุชุญูู ูู ุงููููุฉ:
- **ุฑูู ุงููููุฉ** (id_number)
- **ููุน ุงููููุฉ** (id_type):
  - ูููุฉ ูุทููุฉ
  - ุฅูุงูุฉ
  - ุฌูุงุฒ ุณูุฑ
  - ูููุฉ ุฎููุฌูุฉ
- **ุชุงุฑูุฎ ุงููููุงุฏ** (birth_date) ูุน ุฏุนู ุงูุชูููู ุงููุฌุฑู/ุงููููุงุฏู
- **ุตูุฑุฉ ุงููููุฉ** (id_copy_image) - ุฑูุน ุนุจุฑ ุงููุงููุฑุง ุฃู ุงููุนุฑุถ

**ุงูุญุฒูุฉ ุงููุณุชุฎุฏูุฉ:** `image_picker: ^1.0.4`

---

### 2๏ธโฃ ูููุฏ ูุณุงุฆู ุงูุฏูุน
ุชู ุชูููุฏ ูุณุงุฆู ุงูุฏูุน ูุชุชูุงุณุจ ูุน ุทุจูุนุฉ ุนูููุฉ ุดุฑุงุก ุงููุณุฑ:

**ุงููุณุงุฆู ุงููุณููุญุฉ ููุท:**
- โ ููุฏ (cash)
- โ ุชุญููู ุจููู (bank_transfer)

**ุงููุณุงุฆู ุงูููููุนุฉ:**
- โ ุขุฌู (credit)
- โ ุจุทุงูุงุช ุงุฆุชูุงู
- โ ุทุฑู ุฏูุน ุฃุฎุฑู

**ููุฏ ุงูุชุตููุฉ:**
```dart
_paymentMethods = normalizedMethods.where((method) {
  final type = method['type']?.toString().toLowerCase() ?? '';
  final name = method['name']?.toString().toLowerCase() ?? '';
  return type == 'cash' || type == 'bank_transfer' ||
         name.contains('ููุฏ') || name.contains('ุชุญููู');
}).toList();
```

---

### 3๏ธโฃ ูุธุงู ุชุตููุฑ ุงูุฐูุจ ุงููุดุชุฑู

#### ุงููุงุฌูุฉ:
- **Card** ุงุญุชุฑุงููุฉ ุจุนููุงู "ุตูุฑ ุงูุฐูุจ ุงููุดุชุฑู"
- ุฃุฒุฑุงุฑ **ุชุตููุฑ** ู**ูุนุฑุถ** ููุนููุฉ ุจุงููุงูู
- ุนุฑุถ ุงูุตูุฑ ูู **Grid** ุจูุณุจุฉ 3 ุฃุนูุฏุฉ
- ุฒุฑ **ุญุฐู** ุนูู ูู ุตูุฑุฉ

#### ุงูุชุฎุฒูู:
```dart
final List<File> _goldImages = [];
final ImagePicker _imagePicker = ImagePicker();
```

#### ุงููุธุงุฆู:
- **ุงูุชุตููุฑ ุงููุจุงุดุฑ:**
```dart
final XFile? image = await _imagePicker.pickImage(
  source: ImageSource.camera,
  imageQuality: 80,
  maxWidth: 1920,
);
```

- **ุงุฎุชูุงุฑ ูู ุงููุนุฑุถ:**
```dart
final List<XFile> images = await _imagePicker.pickMultiImage(
  imageQuality: 80,
  maxWidth: 1920,
);
```

#### ูู ุงููุงุชูุฑุฉ:
```json
{
  "gold_images_count": 3
}
```

โ๏ธ **ููุงุญุธุฉ:** ุฑูุน ุงูุตูุฑ ุฅูู ุงูุณูุฑูุฑ ูุญุชุงุฌ endpoint ูููุตู (multipart/form-data)

---

### 4๏ธโฃ ุญุงูุฉ ุงูุฐูุจ ูุงูููุงุญุธุงุช

#### ุญูู ุญุงูุฉ ุงูุฐูุจ (Dropdown):
```dart
String _goldCondition = 'ูุณุชุนูู'; // ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ
```

**ุงูุฎูุงุฑุงุช ุงููุชุงุญุฉ:**
- ุฌุฏูุฏ
- ูุณุชุนูู (ุงูุชุฑุงุถู)
- ูุญุฑูู
- ููุณูุฑ

#### ุญูู ุงูููุงุญุธุงุช:
```dart
final TextEditingController _purchaseNotesController = TextEditingController();
```
- **ููุน:** TextField ูุชุนุฏุฏ ุงูุฃุณุทุฑ (4 ุฃุณุทุฑ)
- **ูุญุงุฐุงุฉ:** RTL ููุนุฑุจูุฉ
- **ุงุณุชุฎุฏุงู:** ููุงุญุธุงุช ุฅุถุงููุฉ ุนู ุงูุฐูุจ ุงููุดุชุฑู

#### ูู ุงููุงุชูุฑุฉ:
```json
{
  "notes": "ุฐูุจ ูุณุชุนูู ุจุญุงูุฉ ุฌูุฏุฉ",
  "gold_condition": "ูุณุชุนูู"
}
```

---

### 5๏ธโฃ ูุธุงู ุชูููู ุงูุณุนุฑ ูุน ุงูุฎุตู

#### ูุณุจุฉ ุงูุฎุตู:
```dart
final TextEditingController _discountPercentageController = TextEditingController(text: '0');
double _discountPercentage = 0.0;
```

**ูููุฏ:**
- ุงููุทุงู: 0% - 100%
- ุงูุชุญุฏูุซ: ููุฑู ุนูุฏ ุงูุชุบููุฑ

#### ุญุณุงุจ ุงูุณุนุฑ ุงููุฎููุถ:
```dart
double _calculateDiscountedTotal() {
  final total = _calculateGrandTotal();
  return total - (total * _discountPercentage / 100);
}
```

#### ุงูุนุฑุถ ูู ุงููุงุฌูุฉ:

**ูู ูุณู ุงูููุงุญุธุงุช:**
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ูุณุจุฉ ุงูุฎุตู (%)  โ  ุงูุณุนุฑ ุจุนุฏ ุงูุฎุตู โ
โ       10        โ    4500.00 ุฑ.ุณ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ูู ูุณู ุงูุฏูุนุงุช:**
```
ูุจู ุงูุฎุตู: 5000.00 ุฑ.ุณ  [ูุดุทูุจ]
ุฎุตู 10.0%  [ุฃุฒุฑู]
ุงูุฅุฌูุงูู: 4500.00 ุฑ.ุณ  [ุฃุฎุถุฑ ุจุงุฑุฒ]
```

#### ูู ุงููุงุชูุฑุฉ:
```json
{
  "total": 4500.00,                    // ุงูุณุนุฑ ุงูููุงุฆู
  "total_before_discount": 5000.00,    // ุงูุณุนุฑ ุงูุฃุตูู
  "discount_percentage": 10.0,
  "discounted_total": 4500.00
}
```

---

## ๐ ุงูุชูุงูู ูุน ุงููุธุงู

### 1. ูุญุต ุงูุฏูุน:
ูุชู ุงูุชุญูู ูู ุงูุชูุงู ุงูุฏูุน ุจุงุณุชุฎุฏุงู **ุงูุณุนุฑ ุงููุฎููุถ**:
```dart
final total = _calculateDiscountedTotal(); // ููุณ _calculateGrandTotal()
final remaining = (total - _totalPayments).abs();

if (remaining > 0.01) { // tolerance = 1 ูุฑุด
  _showError('ุงููุจูุบ ุงููุชุจูู: ${remaining.toStringAsFixed(2)}...');
  return;
}
```

### 2. ุฅุฑุณุงู ุงููุงุชูุฑุฉ:
```dart
final invoiceData = {
  'customer_id': customerId,
  'transaction_type': 'buy',
  'date': DateTime.now().toIso8601String(),
  'total': totalAmount,                      // ุงูุณุนุฑ ุงููุฎููุถ
  'total_before_discount': totalBeforeDiscount,
  'total_weight': totalWeight,
  'total_cost': totalCost,
  'total_tax': totalTax,
  'payments': [...],
  'amount_paid': _totalPayments,
  'items': [...],
  // ุจูุงูุงุช ุดุฑุงุก ุงููุณุฑ ุงูุฅุถุงููุฉ:
  'notes': _purchaseNotesController.text.trim(),
  'gold_condition': _goldCondition,
  'discount_percentage': _discountPercentage,
  'discounted_total': totalAmount,
  'gold_images_count': _goldImages.length,
};
```

### 3. ุนุฑุถ ุงูููุฎุต:
ูู ูุณู **Payment Section**ุ ูุชู ุนุฑุถ:
- ุงูุณุนุฑ ูุจู ุงูุฎุตู (ูุดุทูุจ) - ุฅุฐุง ูุงู ุงูุฎุตู > 0
- ูุณุจุฉ ุงูุฎุตู (ูููู ุจุงูุฃุฒุฑู)
- ุงูุณุนุฑ ุงูููุงุฆู (ุจุงุฑุฒ ุจุงูุฃุฎุถุฑ)

---

## ๐ ุชุฑุชูุจ ุงูุฃูุณุงู ูู ุงูุดุงุดุฉ

```
1. โโ Smart Input Section โโโโโโโโโโโโโโโโโโโโโ
   โ (ุงูุจุญุซ ูุงูุฅุฏุฎุงู ุงูุฐูู - ุงุณู/ููุฏ/ุจุงุฑููุฏ)  โ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

2. โโ Data Table โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   โ (ุฌุฏูู ุงูุฃุตูุงู ุงููุถุงูุฉ)                   โ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

3. โโ Action Buttons โโโโโโโโโโโโโโโโโโโโโโโโโโ
   โ (ุฅุถุงูุฉ ุตูู ูุฏููุงู - ุชูุฑูุบ - ุญุฐู ุงููู)    โ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

4. โโ Gold Images Section โโโโโโโโโโโโโโโโโโโโโ  โญ ุฌุฏูุฏ
   โ (ุตูุฑ ุงูุฐูุจ ุงููุดุชุฑู - ูุงููุฑุง/ูุนุฑุถ)       โ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

5. โโ Notes & Condition Section โโโโโโโโโโโโโโโ  โญ ุฌุฏูุฏ
   โ โข ุญุงูุฉ ุงูุฐูุจ: [Dropdown]                 โ
   โ โข ูุณุจุฉ ุงูุฎุตู: [%] โ ุงูุณุนุฑ ุงููุฎููุถ         โ
   โ โข ููุงุญุธุงุช ุงูุดุฑุงุก: [TextField ูุชุนุฏุฏ]      โ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

6. โโ Payment Section โโโโโโโโโโโโโโโโโโโโโโโโโ
   โ (ูุณุงุฆู ุงูุฏูุน - ููุฏ/ุชุญููู ููุท)            โ
   โ โข ุนุฑุถ ุงูุณุนุฑ ูุจู/ุจุนุฏ ุงูุฎุตู                โ
   โ โข ุฌุฏูู ุงูุฏูุนุงุช                            โ
   โ โข ุงููุชุจูู/ุงููุฏููุน                         โ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐จ ุงูุฃููุงู ูุงูุชุตููู

### ุญููู ุงููุนูููุงุช:
- **ุตูุฑ ุงูุฐูุจ:** `AppColors.info` (ุฃุฒุฑู)
- **ุงูููุงุญุธุงุช ูุงูุญุงูุฉ:** `AppColors.warning` (ุจุฑุชูุงูู)
- **ูุณุจุฉ ุงูุฎุตู:** `AppColors.info` (ุฃุฒุฑู)
- **ุงูุณุนุฑ ุงููุฎููุถ:** `AppColors.success` (ุฃุฎุถุฑ)

### ุงูุฃููููุงุช:
- ๐ท `Icons.photo_camera` - ุตูุฑ ุงูุฐูุจ
- ๐ `Icons.note_alt_outlined` - ุงูููุงุญุธุงุช
- ๐ฐ `Icons.payment` - ุงูุฏูุนุงุช

---

## ๐ง ูุชุทูุจุงุช Backend

### ุญููู ุฌุฏูุฏุฉ ูู ุฌุฏูู `invoices`:
```sql
ALTER TABLE invoices ADD COLUMN notes TEXT;
ALTER TABLE invoices ADD COLUMN gold_condition VARCHAR(20);
ALTER TABLE invoices ADD COLUMN discount_percentage DECIMAL(5,2) DEFAULT 0;
ALTER TABLE invoices ADD COLUMN total_before_discount DECIMAL(10,2);
ALTER TABLE invoices ADD COLUMN gold_images_count INTEGER DEFAULT 0;
```

### ุญููู ุฌุฏูุฏุฉ ูู ุฌุฏูู `customers`:
```sql
ALTER TABLE customers ADD COLUMN id_number VARCHAR(50);
ALTER TABLE customers ADD COLUMN id_type VARCHAR(20);
ALTER TABLE customers ADD COLUMN birth_date DATE;
ALTER TABLE customers ADD COLUMN id_copy_path VARCHAR(255);
```

### Endpoint ูุทููุจ ูุฑูุน ุงูุตูุฑ:
```python
@app.route('/api/invoices/<int:invoice_id>/upload_images', methods=['POST'])
def upload_gold_images(invoice_id):
    # multipart/form-data handler
    # ุญูุธ ุงูุตูุฑ ูู /uploads/gold_images/{invoice_id}/
    # ุชุญุฏูุซ gold_images_count ูู ุฌุฏูู invoices
    pass
```

---

## โ ุงูุงุฎุชุจุงุฑ

### ุณููุงุฑูู 1: ุนููู ุฌุฏูุฏ ูุน ูููุฉ
1. ุงุถุบุท "ุฅุถุงูุฉ ุนููู"
2. ุฃุฏุฎู ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
3. ุงุฎุชุฑ ููุน ุงููููุฉ
4. ุฃุฏุฎู ุฑูู ุงููููุฉ
5. ุญุฏุฏ ุชุงุฑูุฎ ุงููููุงุฏ
6. ุงูุชูุท ุตูุฑุฉ ุงููููุฉ
7. ุงุญูุธ

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** ูุชู ุญูุธ ุงูุนููู ูุน ุฌููุน ุงูุจูุงูุงุช

### ุณููุงุฑูู 2: ูุงุชูุฑุฉ ูุน ุฎุตู
1. ุฃุถู ุฃุตูุงู ูููุงุชูุฑุฉ
2. ุงูุชูุท ุตูุฑ ููุฐูุจ
3. ุงุฎุชุฑ ุญุงูุฉ ุงูุฐูุจ: "ูุณุชุนูู"
4. ุฃุฏุฎู ูุณุจุฉ ุฎุตู: 15%
5. ุฃุถู ููุงุญุธุงุช
6. ุฃุถู ุฏูุนุฉ ููุฏูุฉ ุจูููุฉ ุงูุณุนุฑ ุงููุฎููุถ
7. ุงุญูุธ ุงููุงุชูุฑุฉ

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** 
- ูุชู ุญุณุงุจ ุงูุฎุตู ุชููุงุฆูุงู
- ูุธูุฑ ุงูุณุนุฑ ูุจู ูุจุนุฏ ุงูุฎุตู
- ูุชู ูุจูู ุงูุฏูุนุฉ ุงููุณุงููุฉ ููุณุนุฑ ุงููุฎููุถ

### ุณููุงุฑูู 3: ูุญุงููุฉ ุงุณุชุฎุฏุงู ูุณููุฉ ุฏูุน ููููุนุฉ
1. ุญุงูู ุฅุถุงูุฉ ุฏูุนุฉ ุขุฌูุฉ

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** ูุง ุชุธูุฑ ูุณููุฉ "ุขุฌู" ูู ุงููุงุฆูุฉ

---

## ๐ ููุงุญุธุงุช ุงูุชุทููุฑ

### ุชู ุงูุชูููุฐ โ
- โ ูุธุงู KYC ูุงูู
- โ ุชูููุฏ ูุณุงุฆู ุงูุฏูุน
- โ ุชุตููุฑ ุงูุฐูุจ (UI + ูุธุงุฆู)
- โ ุญุงูุฉ ุงูุฐูุจ ูุงูููุงุญุธุงุช
- โ ูุธุงู ุงูุฎุตู ูุน ุงูุญุณุงุจุงุช
- โ ุนุฑุถ ุงูุณุนุฑ ูุจู/ุจุนุฏ ุงูุฎุตู
- โ ุชุซุจูุช `image_picker: ^1.0.4`
- โ ุฑุจุท ุฌููุน ุงูุญููู ุจู `invoiceData`

### ููุฏ ุงูุงูุชุธุงุฑ โณ
- โณ Backend endpoint ูุฑูุน ุงูุตูุฑ
- โณ ุชุญุฏูุซุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โณ ุนุฑุถ ุงูููุงุชูุฑ ูุน ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ
- โณ ุชูุงุฑูุฑ ุชุญููููุฉ ูุญุงูุฉ ุงูุฐูุจ ูุงูุฎุตููุงุช

---

## ๐ ูููุงุช ุฐุงุช ุตูุฉ

- `frontend/lib/screens/scrap_purchase_invoice_screen.dart` - ุงูููู ุงูุฑุฆูุณู
- `frontend/pubspec.yaml` - ุฅุถุงูุฉ `image_picker: ^1.0.4`
- `backend/models.py` - ุชุญุฏูุซุงุช ููุงุฐุฌ ุงูุจูุงูุงุช (ูุทููุจ)
- `backend/routes.py` - endpoint ุฑูุน ุงูุตูุฑ (ูุทููุจ)

---

**ุชุงุฑูุฎ ุงูุฅูุดุงุก:** 18 ุฃูุชูุจุฑ 2025  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุงุณุชุฎุฏุงู (Frontend ูุงูู)  
**ุงูุฅุตุฏุงุฑ:** 1.0.0
