# ุญุฐู ูุณููุฉ ุงูุฏูุน (Delete Payment Method)

## ๐ ุงููุตู
ููุฒุฉ ุญุฐู ูุณููุฉ ุฏูุน ูุน **ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ูุนุงููุงุช ูุฑุชุจุทุฉ ุจูุง**.

---

## โจ ุงูููุฒุงุช

### 1. **ุงูุชุญูู ูู ุงููุนุงููุงุช**
ูุจู ุงูุญุฐูุ ูุชุญูู ุงููุธุงู ูู:
- ุนุฏู ูุฌูุฏ ููุงุชูุฑ ูุฑุชุจุทุฉ ุจูุณููุฉ ุงูุฏูุน
- ุฅุฐุง ูุฌุฏุช ููุงุชูุฑุ ูุชู ุฑูุถ ุงูุญุฐู ูุน ุฑุณุงูุฉ ูุงุถุญุฉ

### 2. **ุชุฃููุฏ ุงูุญุฐู**
- Dialog ุชุฃููุฏ ูุน ุชุญุฐูุฑ ูุงุถุญ
- ูุง ูููู ุงูุชุฑุงุฌุน ุนู ุงูุญุฐู
- ุฒุฑ ุฃุญูุฑ ููุชุฃููุฏ

### 3. **ุญุฐู ูุนูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช**
- **ููุณ** soft delete
- ูุชู ุญุฐู ุงูุณุฌู ุจุงููุงูู ูู ุฌุฏูู `payment_method`
- ููุงุณุจ ูููุณุงุฆู ุงูุชู ุชู ุฅุถุงูุชูุง ุจุงูุฎุทุฃ

---

## ๐จ ูุงุฌูุฉ ุงููุณุชุฎุฏู

### ุฒุฑ ุงูุญุฐู
```dart
IconButton(
  icon: const Icon(Icons.delete_outline, color: Colors.red),
  onPressed: () => _deletePaymentMethod(index),
  tooltip: 'ุญุฐู',
)
```

**ุงููููุน:** ุจุฌุงูุจ ุฒุฑ ุงูุชุนุฏูู ูุฒุฑ Toggle ูู ูู ูุณููุฉ ุฏูุน

---

## ๐ง ุงูุชูููุฐ ุงูุชููู

### Backend (Flask)

```python
@api.route('/payment-methods/<int:id>', methods=['DELETE'])
def delete_payment_method(id):
    """ุญุฐู ูุณููุฉ ุฏูุน (ูุน ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ูุนุงููุงุช)"""
    try:
        payment_method = PaymentMethod.query.get_or_404(id)
        
        # ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ููุงุชูุฑ ูุฑุชุจุทุฉ
        invoice_count = db.session.query(func.count(Invoice.id)).filter(
            Invoice.payment_method_id == id
        ).scalar()
        
        if invoice_count > 0:
            return jsonify({
                'status': 'error',
                'message': f'ูุง ูููู ุญุฐู ูุณููุฉ ุงูุฏูุน "{payment_method.name}" ูุฃููุง ูุณุชุฎุฏูุฉ ูู {invoice_count} ูุงุชูุฑุฉ',
                'invoice_count': invoice_count
            }), 400
        
        # ุญุฐู ูุนูู
        db.session.delete(payment_method)
        db.session.commit()
        
        return jsonify({
            'status': 'success',
            'message': f'ุชู ุญุฐู ูุณููุฉ ุงูุฏูุน "{payment_method.name}" ุจูุฌุงุญ'
        }), 200
        
    except Exception as e:
        db.session.rollback()
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500
```

### Frontend (Flutter)

```dart
Future<void> _deletePaymentMethod(int index) async {
  final method = _paymentMethods[index];
  final methodId = method['id'];
  final methodName = method['name'];
  
  // ุชุฃููุฏ ุงูุญุฐู
  final confirmed = await showDialog<bool>(
    context: context,
    builder: (context) => AlertDialog(
      title: const Text('ุญุฐู ูุณููุฉ ุงูุฏูุน'),
      content: Column(
        children: [
          Text('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู "$methodName"ุ'),
          // ุชุญุฐูุฑ ุจุนุฏู ุฅููุงููุฉ ุงูุชุฑุงุฌุน
          Container(
            padding: EdgeInsets.all(12),
            color: Colors.red.shade50,
            child: Row(
              children: [
                Icon(Icons.warning_amber, color: Colors.red),
                Text('ุชุญุฐูุฑ: ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก!'),
              ],
            ),
          ),
        ],
      ),
      actions: [
        TextButton(child: Text('ุฅูุบุงุก')),
        ElevatedButton(
          style: ElevatedButton.styleFrom(backgroundColor: Colors.red),
          child: Text('ุญุฐู'),
        ),
      ],
    ),
  );
  
  if (confirmed != true) return;
  
  try {
    await _apiService.deletePaymentMethod(methodId);
    
    setState(() {
      _paymentMethods.removeAt(index);
    });
    
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text('โ ุชู ุญุฐู "$methodName" ุจูุฌุงุญ')),
    );
    
  } catch (e) {
    String errorMessage = e.toString();
    
    if (errorMessage.contains('400')) {
      errorMessage = 'ูุง ูููู ุญุฐู ูุณููุฉ ุงูุฏูุน ูุฃููุง ูุณุชุฎุฏูุฉ ูู ููุงุชูุฑ';
    }
    
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(errorMessage),
        backgroundColor: Colors.red,
        duration: Duration(seconds: 5),
      ),
    );
  }
}
```

---

## ๐ ุงูุณููุงุฑูููุงุช

### โ ุงูุณููุงุฑูู 1: ุญุฐู ูุงุฌุญ
**ุงูุดุฑุท:** ูุณููุฉ ุฏูุน ุบูุฑ ูุณุชุฎุฏูุฉ ูู ุฃู ูุงุชูุฑุฉ

**ุงูุฎุทูุงุช:**
1. ุงููุณุชุฎุฏู ูุถุบุท ุนูู ุฒุฑ ุงูุญุฐู (๐๏ธ)
2. ูุธูุฑ dialog ุชุฃููุฏ ูุน ุชุญุฐูุฑ
3. ุงููุณุชุฎุฏู ูุคูุฏ ุงูุญุฐู
4. Backend ูุชุญูู ูู ุนุฏู ูุฌูุฏ ููุงุชูุฑ
5. ูุชู ุญุฐู ูุณููุฉ ุงูุฏูุน ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
6. ุชูุญุฏูุซ ุงููุงุฆูุฉ ูู Frontend
7. ุฑุณุงูุฉ ูุฌุงุญ: "โ ุชู ุญุฐู 'ุงุณู ุงููุณููุฉ' ุจูุฌุงุญ"

**ุงููุชูุฌุฉ:**
- โ ุงูุณุฌู ูุญุฐูู ูู `payment_method`
- โ ูุง ุชุธูุฑ ูู ุงููุงุฆูุฉ
- โ ูุง ูููู ุงุณุชุฎุฏุงููุง ูู ููุงุชูุฑ ุฌุฏูุฏุฉ

---

### โ ุงูุณููุงุฑูู 2: ูุดู ุงูุญุฐู (ูุณุชุฎุฏูุฉ)
**ุงูุดุฑุท:** ูุณููุฉ ุฏูุน ูุณุชุฎุฏูุฉ ูู ููุงุชูุฑ

**ุงูุฎุทูุงุช:**
1. ุงููุณุชุฎุฏู ูุถุบุท ุนูู ุฒุฑ ุงูุญุฐู
2. ูุธูุฑ dialog ุชุฃููุฏ
3. ุงููุณุชุฎุฏู ูุคูุฏ ุงูุญุฐู
4. Backend ูุชุญูู ููุฌุฏ **3 ููุงุชูุฑ** ูุฑุชุจุทุฉ
5. Backend ูุฑุฌุน ุฎุทุฃ 400:
```json
{
  "status": "error",
  "message": "ูุง ูููู ุญุฐู ูุณููุฉ ุงูุฏูุน 'ูุฏู' ูุฃููุง ูุณุชุฎุฏูุฉ ูู 3 ูุงุชูุฑุฉ",
  "invoice_count": 3
}
```
6. Frontend ูุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ

**ุงููุชูุฌุฉ:**
- โ ูู ูุชู ุงูุญุฐู
- โ ุงูุจูุงูุงุช ูุญููุฉ
- โ ุงููุณุชุฎุฏู ูุนุฑู ุงูุณุจุจ

---

## ๐ฏ ุงููุฑููุงุช ุจูู ุงูุญุฐู ู Toggle

| ุงูููุฒุฉ | ุญุฐู (Delete) | ุชุนุทูู (Toggle) |
|--------|-------------|---------------|
| **ุงูุฅุฌุฑุงุก** | ุญุฐู ููุงุฆู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช | ุชุบููุฑ `is_active` |
| **ุงูุชุฑุงุฌุน** | โ ุบูุฑ ูููู | โ ูููู (ุฅุนุงุฏุฉ ุชูุนูู) |
| **ุงูุดุฑุท** | ูุง ุชูุฌุฏ ููุงุชูุฑ ูุฑุชุจุทุฉ | ูุง ููุฌุฏ ุดุฑุท |
| **ุงูุงุณุชุฎุฏุงู** | ูุณุงุฆู ูุถุงูุฉ ุจุงูุฎุทุฃ | ุฅุฎูุงุก ูุคูุช |
| **ุงูููู** | ๐ด ุฃุญูุฑ | ๐ข/โช ุฃุฎุถุฑ/ุฑูุงุฏู |
| **ุงูุฃููููุฉ** | ๐๏ธ `delete_outline` | ๐ `toggle_on/off` |

---

## ๐ ุงูุฃูุงู

### ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
```python
# ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ูุนุงููุงุช
invoice_count = db.session.query(func.count(Invoice.id)).filter(
    Invoice.payment_method_id == id
).scalar()

if invoice_count > 0:
    return jsonify({'status': 'error', ...}), 400
```

### ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
```python
try:
    db.session.delete(payment_method)
    db.session.commit()
except Exception as e:
    db.session.rollback()  # โ ุชุฑุงุฌุน ุนู ุฃู ุชุบููุฑุงุช
    return jsonify({'status': 'error', ...}), 500
```

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ุงูุญุฐู ููุงุฆู:**
   - ูุง ูููู ุงูุชุฑุงุฌุน
   - ููุญุฐู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุงููุงูู

2. **ุงูุญูุงูุฉ ูู ุงูุญุฐู:**
   - ุฅุฐุง ูุงูุช ุงููุณููุฉ ูุณุชุฎุฏูุฉ ูู ุฃู ูุงุชูุฑุฉ
   - ุฑุณุงูุฉ ุฎุทุฃ ุชุญุชูู ุนูู ุนุฏุฏ ุงูููุงุชูุฑ

3. **ุงูุจุฏูู ุงูุขูู:**
   - ุงุณุชุฎุฏู **Toggle** (ุฅูุบุงุก ุชูุนูู) ุจุฏูุงู ูู ุงูุญุฐู
   - ููุฎูู ุงููุณููุฉ ููู ูุญุชูุธ ุจุงูุจูุงูุงุช

4. **ูุชู ุชุณุชุฎุฏู ุงูุญุฐูุ**
   - ูุณุงุฆู ุฏูุน ูุถุงูุฉ ุจุงูุฎุทุฃ
   - ูุณุงุฆู ุชุฌุฑูุจูุฉ
   - ูุจู ุฅูุดุงุก ุฃู ูุงุชูุฑุฉ

5. **ูุชู ุชุณุชุฎุฏู Toggleุ**
   - ูุณุงุฆู ูู ุชุนุฏ ูุชุงุญุฉ (ูุซู: ุฎุฏูุฉ ุฃููุบูุช)
   - ุฅุฎูุงุก ูุคูุช
   - ุจุนุฏ ุฅูุดุงุก ููุงุชูุฑ

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ Backend (cURL)
```bash
# ูุญุงููุฉ ุญุฐู ูุณููุฉ ุฏูุน ุบูุฑ ูุณุชุฎุฏูุฉ (ID: 12)
curl -X DELETE http://127.0.0.1:8001/api/payment-methods/12

# ุงููุชูุฌุฉ ุงููุชููุนุฉ (ูุฌุงุญ):
{
  "status": "success",
  "message": "ุชู ุญุฐู ูุณููุฉ ุงูุฏูุน 'ุงูุฑููุงู ุงูุณุจุฑุณ' ุจูุฌุงุญ"
}

# ูุญุงููุฉ ุญุฐู ูุณููุฉ ูุณุชุฎุฏูุฉ (ID: 1 - ููุฏุงู)
curl -X DELETE http://127.0.0.1:8001/api/payment-methods/1

# ุงููุชูุฌุฉ ุงููุชููุนุฉ (ูุดู):
{
  "status": "error",
  "message": "ูุง ูููู ุญุฐู ูุณููุฉ ุงูุฏูุน 'ููุฏุงู' ูุฃููุง ูุณุชุฎุฏูุฉ ูู 15 ูุงุชูุฑุฉ",
  "invoice_count": 15
}
```

### ุงุฎุชุจุงุฑ Frontend
1. ุงูุชุญ ุดุงุดุฉ ุงูุฅุนุฏุงุฏุงุช โ ุชุจููุจ "ูุณุงุฆู ุงูุฏูุน"
2. ุงุจุญุซ ุนู ูุณููุฉ **ุบูุฑ ูุณุชุฎุฏูุฉ** (ูุซู: ุงูุฑููุงู ุงูุณุจุฑุณ)
3. ุงุถุบุท ุนูู ุฒุฑ ุงูุญุฐู (๐๏ธ ุฃุญูุฑ)
4. ุชุฃูุฏ ูู:
   - โ ูุธูุฑ dialog ุชุฃููุฏ ูุน ุชุญุฐูุฑ ูุงุถุญ
   - โ ุฒุฑ "ุญุฐู" ุฃุญูุฑ
   - โ ุฑุณุงูุฉ ูุฌุงุญ ุชุธูุฑ
   - โ ุงููุณููุฉ ุชุฎุชูู ูู ุงููุงุฆูุฉ

5. ุฌุฑูุจ ุญุฐู ูุณููุฉ **ูุณุชุฎุฏูุฉ** (ูุซู: ููุฏุงู)
6. ุชุฃูุฏ ูู:
   - โ dialog ุงูุชุฃููุฏ ูุธูุฑ
   - โ Backend ูุฑูุถ ุงูุญุฐู
   - โ ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ ุชุธูุฑ ููุฏุฉ 5 ุซูุงูู
   - โ ุงููุณููุฉ ุชุจูู ูู ุงููุงุฆูุฉ

---

## โ ุงูุฎูุงุตุฉ

ุชู ุฅุถุงูุฉ ููุฒุฉ **ุญุฐู ูุณููุฉ ุงูุฏูุน** ูุน:
- โ ุชุญูู ูู ุนุฏู ูุฌูุฏ ูุนุงููุงุช
- โ dialog ุชุฃููุฏ ูุน ุชุญุฐูุฑ
- โ ุญุฐู ูุนูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ
- โ ุญูุงูุฉ ููุจูุงูุงุช ุงููุฑุชุจุทุฉ

**ุงููููุงุช ุงููุนุฏููุฉ:**
- `backend/routes.py` โ endpoint `/payment-methods/<id>` (DELETE)
- `frontend/lib/screens/settings_screen.dart` โ ุฏุงูุฉ `_deletePaymentMethod()`
- `frontend/lib/api_service.dart` โ ุฏุงูุฉ `deletePaymentMethod()` (ููุฌูุฏุฉ ูุณุจูุงู)
