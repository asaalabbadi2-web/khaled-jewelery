# العلاقة بين الفواتير والسندات والقيود

## 🔄 الدورة المستندية الكاملة

```
┌─────────────────────────────────────────────────────────┐
│                   📊 العملية التجارية                   │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                   📄 الفاتورة (Invoice)                 │
│  ┌────────────────────────────────────────────────┐    │
│  │ • رقم الفاتورة: INV-2025-00123                │    │
│  │ • النوع: بيع / شراء / مرتجع                   │    │
│  │ • العميل/المورد                                │    │
│  │ • الأصناف والكميات                            │    │
│  │ • الإجمالي: 10,000 ريال                       │    │
│  │ • الحالة: unpaid / paid / partially_paid     │    │
│  └────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
                    ┌───────┴───────┐
                    │               │
                    ▼               ▼
        ┌───────────────┐   ┌───────────────┐
        │  💰 نقدي      │   │  📝 آجل       │
        └───────────────┘   └───────────────┘
                │                   │
                ▼                   ▼
    ┌─────────────────┐     ┌─────────────────┐
    │  سند فوري       │     │  حساب جاري     │
    │  (مع الفاتورة)  │     │  (دين)          │
    └─────────────────┘     └─────────────────┘
                │                   │
                │                   ▼
                │           ┌─────────────────┐
                │           │  سند لاحق       │
                │           │  (عند السداد)   │
                │           └─────────────────┘
                │                   │
                ▼                   ▼
┌─────────────────────────────────────────────────────────┐
│               🧾 السند (Voucher)                        │
│  ┌────────────────────────────────────────────────┐    │
│  │ • رقم السند: RV-2025-00045                    │    │
│  │ • النوع: قبض / صرف                            │    │
│  │ • المبلغ: 10,000 ريال                         │    │
│  │ • طريقة الدفع: نقدي / شيك / بنكي             │    │
│  │ • مرتبط بفاتورة: INV-2025-00123              │    │
│  └────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│            📚 القيد المحاسبي (Journal Entry)            │
│  ┌────────────────────────────────────────────────┐    │
│  │ التاريخ: 2025-10-10                           │    │
│  │ البيان: بيع ذهب للعميل أحمد                  │    │
│  │                                                │    │
│  │ من حـ/ الصندوق       10,000    [مدين] ✓       │    │
│  │     إلى حـ/ المخزون    8,000    [دائن] ✓      │    │
│  │     إلى حـ/ الإيرادات  2,000    [دائن] ✓      │    │
│  │                                                │    │
│  │ الإجمالي المدين = الإجمالي الدائن = 10,000   │    │
│  └────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                📊 تحديث الأرصدة                         │
│  • رصيد الصندوق: +10,000                              │
│  • رصيد المخزون (ذهب): -8,000                         │
│  • رصيد الإيرادات: +2,000                              │
│  • رصيد العميل (إن كان آجل): +10,000                  │
└─────────────────────────────────────────────────────────┘
```

---

## 🎯 السيناريوهات العملية

### السيناريو 1️⃣: بيع نقدي فوري

```
1. إنشاء فاتورة بيع
   ├── العميل: أحمد محمد
   ├── الأصناف: خاتم ذهب عيار 21
   ├── الإجمالي: 5,000 ريال
   └── طريقة الدفع: نقدي فوري
        │
        ▼
2. إنشاء سند قبض (تلقائي أو يدوي)
   ├── النوع: قبض
   ├── المبلغ: 5,000 ريال
   ├── مرتبط بفاتورة: INV-2025-00123
   └── طريقة الدفع: نقدي
        │
        ▼
3. إنشاء قيد محاسبي (تلقائي)
   من حـ/ الصندوق         5,000  [مدين]
       إلى حـ/ المخزون     4,000  [دائن]
       إلى حـ/ الإيرادات   1,000  [دائن]
        │
        ▼
4. تحديث الحالة
   ├── حالة الفاتورة: paid
   └── رصيد الصندوق: +5,000
```

### السيناريو 2️⃣: بيع آجل + تحصيل لاحق

```
1. إنشاء فاتورة بيع آجلة
   ├── العميل: محمد علي
   ├── الإجمالي: 10,000 ريال
   └── طريقة الدفع: آجل
        │
        ▼
2. إنشاء قيد الفاتورة (تلقائي)
   من حـ/ العميل - محمد    10,000  [مدين]
       إلى حـ/ المخزون       8,000  [دائن]
       إلى حـ/ الإيرادات     2,000  [دائن]
        │
        ▼
3. تحديث رصيد العميل
   ├── رصيد محمد: 10,000 ريال (مدين)
   └── حالة الفاتورة: unpaid
        │
        │ (بعد أسبوع...)
        ▼
4. العميل يسدد جزئياً (5,000 ريال)
   ├── إنشاء سند قبض جديد
   ├── المبلغ: 5,000 ريال
   └── مرتبط بالفاتورة الأصلية
        │
        ▼
5. إنشاء قيد التحصيل (تلقائي)
   من حـ/ الصندوق          5,000  [مدين]
       إلى حـ/ العميل - محمد 5,000  [دائن]
        │
        ▼
6. تحديث الحالة
   ├── حالة الفاتورة: partially_paid
   ├── رصيد العميل: 5,000 ريال (متبقي)
   └── رصيد الصندوق: +5,000
```

### السيناريو 3️⃣: شراء + دفع لاحق

```
1. إنشاء فاتورة شراء
   ├── المورد: شركة الذهب العالمية
   ├── الإجمالي: 50,000 ريال
   └── طريقة الدفع: آجل (30 يوم)
        │
        ▼
2. إنشاء قيد الفاتورة
   من حـ/ المخزون              50,000  [مدين]
       إلى حـ/ المورد - الشركة  50,000  [دائن]
        │
        ▼
3. تحديث رصيد المورد
   ├── رصيد الشركة: 50,000 ريال (دائن)
   └── حالة الفاتورة: unpaid
        │
        │ (عند الاستحقاق...)
        ▼
4. دفع للمورد (شيك)
   ├── إنشاء سند صرف
   ├── المبلغ: 50,000 ريال
   ├── طريقة الدفع: شيك
   └── رقم الشيك: 123456
        │
        ▼
5. إنشاء قيد الدفع
   من حـ/ المورد - الشركة    50,000  [مدين]
       إلى حـ/ البنك           50,000  [دائن]
        │
        ▼
6. تحديث الحالة
   ├── حالة الفاتورة: paid
   ├── رصيد المورد: 0
   └── رصيد البنك: -50,000
```

### السيناريو 4️⃣: مرتجع بيع + سند صرف

```
1. العميل يرجع ذهب مشترى
   ├── إنشاء فاتورة مرتجع بيع
   ├── مرتبطة بفاتورة البيع الأصلية
   ├── المبلغ: 5,000 ريال
   └── السبب: عيب في الصنعة
        │
        ▼
2. إنشاء سند صرف للعميل
   ├── النوع: صرف
   ├── المبلغ: 5,000 ريال
   ├── الطرف: العميل
   └── مرتبط بفاتورة المرتجع
        │
        ▼
3. إنشاء قيد المرتجع (عكس البيع)
   من حـ/ المخزون         4,000  [مدين]
   من حـ/ الإيرادات       1,000  [مدين]
       إلى حـ/ الصندوق    5,000  [دائن]
        │
        ▼
4. تحديث الأرصدة
   ├── رصيد المخزون: +4,000
   ├── رصيد الإيرادات: -1,000
   └── رصيد الصندوق: -5,000
```

---

## 📊 جدول العلاقات

| **المستند** | **يولّد** | **يرتبط بـ** | **ينشئ قيد** | **يحدث رصيد** |
|-------------|-----------|--------------|-------------|---------------|
| فاتورة بيع نقدي | سند قبض فوري | - | ✅ قيد بيع | الصندوق، المخزون، الإيرادات |
| فاتورة بيع آجل | - | حساب العميل | ✅ قيد بيع | العميل، المخزون، الإيرادات |
| سند قبض لاحق | - | فاتورة آجلة | ✅ قيد تحصيل | الصندوق، العميل |
| فاتورة شراء آجل | - | حساب المورد | ✅ قيد شراء | المخزون، المورد |
| سند صرف للمورد | - | فاتورة شراء | ✅ قيد دفع | البنك/الصندوق، المورد |
| فاتورة مرتجع بيع | سند صرف | فاتورة البيع الأصلية | ✅ قيد مرتجع | عكس قيد البيع |
| فاتورة مرتجع شراء | سند قبض | فاتورة الشراء الأصلية | ✅ قيد مرتجع | عكس قيد الشراء |

---

## 🎨 تصميم قاعدة البيانات - العلاقات

```sql
-- العلاقات الرئيسية

Invoice (الفاتورة)
├── id
├── invoice_type (بيع، شراء، مرتجع...)
├── customer_id → Customer
├── supplier_id → Supplier
├── original_invoice_id → Invoice (للمرتجعات)
└── status (paid, unpaid, partially_paid)

Voucher (السند)
├── id
├── voucher_type (receipt, payment)
├── customer_id → Customer
├── supplier_id → Supplier
├── related_invoice_id → Invoice
└── journal_entry_id → JournalEntry

JournalEntry (القيد المحاسبي)
├── id
├── reference_type (invoice, voucher, manual)
├── reference_id (id of invoice or voucher)
└── lines → JournalEntryLine[]

JournalEntryLine (سطر القيد)
├── id
├── journal_entry_id → JournalEntry
├── account_id → Account
├── debit_cash
├── debit_gold_21k
├── credit_cash
└── credit_gold_21k
```

---

## ✅ القرار المقترح

### الخيار الأفضل: **نظام هجين**

```
📄 الفاتورة (Invoice)
├── للعمليات الكبيرة والموثقة
├── تحتوي على أصناف متعددة
├── تتطلب موافقات وتوقيعات
└── تنشئ قيد محاسبي تلقائياً

🧾 السند (Voucher)
├── للمعاملات السريعة اليومية
├── دفعات فردية بسيطة
├── تحصيل أو صرف مباشر
└── ينشئ قيد محاسبي تلقائياً

📊 القيد المحاسبي (Journal Entry)
├── ينشأ تلقائياً من الفاتورة أو السند
├── يمكن إنشاؤه يدوياً للتسويات
└── هو المصدر الوحيد لتحديث الأرصدة
```

---

## 🚀 خطة التنفيذ الموصى بها

### المرحلة 1: إكمال نظام الفواتير ✅
1. تحديث Models (تم ✓)
2. Migration
3. API Endpoints
4. القيود المحاسبية للفواتير

### المرحلة 2: إضافة نظام السندات
1. إنشاء Voucher Model
2. API للسندات
3. واجهات Frontend
4. القيود المحاسبية للسندات

### المرحلة 3: التكامل
1. ربط الفواتير بالسندات
2. تحديث الأرصدة تلقائياً
3. التقارير الشاملة

---

**هل تريد المتابعة بإكمال نظام الفواتير أولاً، أم البدء بنظام السندات؟** 🤔
