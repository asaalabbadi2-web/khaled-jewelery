# ุฅุตูุงุญ: ูุดููุฉ ุชููู ุงูุชุทุจูู ุนูุฏ ุฅุถุงูุฉ ูุณููุฉ ุฏูุน
**ุงูุชุงุฑูุฎ:** 13 ุฃูุชูุจุฑ 2025

---

## ๐ ุงููุดููุฉ

ุนูุฏ ุงูุถุบุท ุนูู "ุฅุถุงูุฉ ูุณููุฉ ุฏูุน" ูู ุดุงุดุฉ ุงูุฅุนุฏุงุฏุงุชุ ูุงู ุงูุชุทุจูู ูุชููู ุนู ุงูุงุณุชุฌุงุจุฉ (Freeze/Hang).

---

## ๐ ุงูุณุจุจ ุงูุฌุฐุฑู

### ุงูููุฏ ุงููุฏูู (ุงููุดููุฉ):
```dart
void _addPaymentMethod() async {
  // ...
  showDialog(
    builder: (context) => StatefulBuilder(
      builder: (context, setState) {
        // โ ุงููุดููุฉ: ุฌูุจ ุงูุจูุงูุงุช ุฏุงุฎู builder
        if (isLoading && accounts.isEmpty) {
          _apiService.getAccounts().then((response) {
            setState(() {
              accounts = filteredAccounts;
              isLoading = false;
            });
          });
        }
        
        return AlertDialog(
          content: isLoading ? CircularProgressIndicator() : Form(...),
        );
      },
    ),
  );
}
```

### ููุงุฐุง ูุชุนุทูุ

1. **Infinite rebuild loop:**
   - `builder` ููุณุชุฏุนู
   - ูุฌุฏ `isLoading = true`
   - ูุณุชุฏุนู `getAccounts()`
   - `setState()` ูุนูุฏ ุจูุงุก `builder`
   - ููุณุชุฏุนู `builder` ูุฑุฉ ุฃุฎุฑู
   - ูุฌุฏ `isLoading = true` ูุฑุฉ ุฃุฎุฑู (ูุฃู ุงูู API ูู ููุชูู ุจุนุฏ)
   - ูุณุชุฏุนู `getAccounts()` **ูุฑุฉ ุฃุฎุฑู**
   - ... ุญููุฉ ูุง ููุงุฆูุฉ! ๐

2. **Network overload:**
   - ูุฆุงุช ุงูุทูุจุงุช ุฅูู ุงูู API ูู ุซูุงูู
   - ุงุณุชูุฒุงู ุงูุฐุงูุฑุฉ
   - ุงูุชุทุจูู ูุชุฌูุฏ

---

## โ ุงูุญู

### ุงูููุฏ ุงูุฌุฏูุฏ (ุงูููุตูุญ):
```dart
void _addPaymentMethod() async {
  // 1๏ธโฃ ุนุฑุถ ูุคุดุฑ ุชุญููู ุฃููุงู
  showDialog(
    context: context,
    barrierDismissible: false,
    builder: (context) => const Center(
      child: Card(
        child: Padding(
          padding: EdgeInsets.all(24),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              CircularProgressIndicator(),
              SizedBox(height: 16),
              Text('ุฌุงุฑู ุชุญููู ุงูุญุณุงุจุงุช...'),
            ],
          ),
        ),
      ),
    ),
  );
  
  // 2๏ธโฃ ุฌูุจ ุงูุจูุงูุงุช ูุจู ูุชุญ ุงูู Dialog ุงููุนูู
  List<Map<String, dynamic>> accounts = [];
  try {
    final response = await _apiService.getAccounts();
    accounts = response.where(...).toList();
    accounts.sort(...);
    
    // 3๏ธโฃ ุฅุบูุงู ูุคุดุฑ ุงูุชุญููู
    if (mounted) Navigator.pop(context);
    
  } catch (e) {
    // 4๏ธโฃ ุฅุบูุงู ูุคุดุฑ ุงูุชุญููู
    if (mounted) Navigator.pop(context);
    
    // 5๏ธโฃ ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text('โ ูุดู ุชุญููู ุงูุญุณุงุจุงุช: $e')),
    );
    return; // โ ูุง ูุนุฑุถ ุงูู Dialog
  }
  
  // 6๏ธโฃ ุงูุขู ูุนุฑุถ ุงูู Dialog ุงููุนูู (ุงูุจูุงูุงุช ุฌุงูุฒุฉ)
  showDialog(
    context: context,
    builder: (context) => AlertDialog(
      title: const Text('ุฅุถุงูุฉ ูุณููุฉ ุฏูุน ุฌุฏูุฏุฉ'),
      content: SingleChildScrollView(
        // โ ุงูุจูุงูุงุช ูุชุงุญุฉ ููุฑุงู
        child: DropdownButtonFormField<int>(
          items: accounts.map(...).toList(),
        ),
      ),
    ),
  );
}
```

---

## ๐ฏ ุงููุฑู ุงูุฃุณุงุณู

| ุงููุดููุฉ ุงููุฏููุฉ | ุงูุญู ุงูุฌุฏูุฏ |
|-----------------|-------------|
| ุฌูุจ ุงูุจูุงูุงุช **ุฏุงุฎู** builder | ุฌูุจ ุงูุจูุงูุงุช **ูุจู** ูุชุญ Dialog |
| ุญููุฉ ูุง ููุงุฆูุฉ ูู ุงูุทูุจุงุช | ุทูุจ ูุงุญุฏ ููุท |
| Dialog ููุนุงุฏ ุจูุงุคู ูุฆุงุช ุงููุฑุงุช | Dialog ููุจูู ูุฑุฉ ูุงุญุฏุฉ |
| ุชุนุทู ุงูุชุทุจูู | ูุนูู ุจุณูุงุณุฉ โ |

---

## ๐ ุชุฏูู ุงูุนูู ุงูุฌุฏูุฏ

```
ุงููุณุชุฎุฏู ูุถุบุท "ุฅุถุงูุฉ" 
      โ
ุนุฑุถ ูุคุดุฑ ุชุญููู (dialog ุจุณูุท)
      โ
await getAccounts() (ููุชุธุฑ ุญุชู ููุชูู)
      โ
ุฅุบูุงู ูุคุดุฑ ุงูุชุญููู
      โ
ูุฌุญุ โ ุนุฑุถ Dialog ุงูุฅุถุงูุฉ (ุงูุจูุงูุงุช ุฌุงูุฒุฉ)
ูุดูุ โ ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ + ุฅุบูุงู
```

---

## โจ ุงูุชุญุณููุงุช ุงูุฅุถุงููุฉ

### 1. **ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:**
```dart
catch (e) {
  Navigator.pop(context); // ุฅุบูุงู ุงูุชุญููู
  ScaffoldMessenger.of(context).showSnackBar(
    SnackBar(content: Text('โ ูุดู: $e')),
  );
  return; // ูุง ุชุนุฑุถ Dialog ูุนุทูุจ
}
```

### 2. **ุงูุชุญูู ูู ุงูุจูุงูุงุช:**
```dart
if (accounts.isEmpty) {
  ScaffoldMessenger.of(context).showSnackBar(
    const SnackBar(content: Text('โ๏ธ ูุง ุชูุฌุฏ ุญุณุงุจุงุช ูุชุงุญุฉ')),
  );
  return;
}
```

### 3. **ุงูุชุญูู ูู mounted:**
```dart
if (mounted) Navigator.pop(context); // ุขูู
```

---

## ๐ ุงูุฃุฏุงุก

### ูุจู ุงูุฅุตูุงุญ:
- โฑ๏ธ ููุช ุงูุงุณุชุฌุงุจุฉ: ุบูุฑ ูุญุฏูุฏ (ุชุนุทู)
- ๐ก ุนุฏุฏ ุงูุทูุจุงุช: 100-500+ ุทูุจ/ุซุงููุฉ
- ๐พ ุงุณุชููุงู ุงูุฐุงูุฑุฉ: ูุชุตุงุนุฏ ุจุณุฑุนุฉ
- ๐ด ุงููุชูุฌุฉ: ุชุนุทู ุงูุชุทุจูู

### ุจุนุฏ ุงูุฅุตูุงุญ:
- โฑ๏ธ ููุช ุงูุงุณุชุฌุงุจุฉ: 1-2 ุซุงููุฉ
- ๐ก ุนุฏุฏ ุงูุทูุจุงุช: 1 ุทูุจ ููุท
- ๐พ ุงุณุชููุงู ุงูุฐุงูุฑุฉ: ุทุจูุนู
- โ ุงููุชูุฌุฉ: ูุนูู ุจุณูุงุณุฉ

---

## ๐ ุงูุฏุฑุณ ุงููุณุชูุงุฏ

### โ **ูุง ุชูุนู:**
```dart
builder: (context, setState) {
  if (needData) {
    fetchData().then((data) {
      setState(() { ... }); // ูุณุจุจ ุฅุนุงุฏุฉ ุจูุงุก
    });
  }
  return Widget(...);
}
```

### โ **ุงูุนู:**
```dart
// ุฌูุจ ุงูุจูุงูุงุช ุฃููุงู
final data = await fetchData();

// ุซู ุจูุงุก ุงูู Widget
showDialog(
  builder: (context) => Widget(data: data),
);
```

---

## ๐ ุงููุงุนุฏุฉ ุงูุฐูุจูุฉ

> **ูุง ุชุฌูุจ ุจูุงูุงุช ุบูุฑ ูุชุฒุงููุฉ (async) ุฏุงุฎู ุฏุงูุฉ `builder`**
> 
> ุฏุงุฆูุงู ุงุฌูุจ ุงูุจูุงูุงุช **ูุจู** ุจูุงุก ุงูู Widget

---

## ๐ง ุงููููุงุช ุงููุนุฏูุฉ

- โ `frontend/lib/screens/settings_screen.dart`
  * `_addPaymentMethod()` - ุฅุนุงุฏุฉ ููููุฉ ูุงููุฉ
  * ุฅุถุงูุฉ ูุคุดุฑ ุชุญููู ูููุตู
  * ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุญุณููุฉ

---

## โ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

- ๐ ุงูุชุทุจูู ูุณุชุฌูุจ ููุฑุงู
- โก ุณุฑุนุฉ ุชุญููู ุณุฑูุนุฉ
- ๐ฏ ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุงุถุญุฉ
- ๐ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ููุชุงุฒุฉ

---

**ุงูุฎูุงุตุฉ:** ุงููุดููุฉ ูุงูุช ูู **ุชูููุช** ุฌูุจ ุงูุจูุงูุงุช. ุงูุญู ูู ุฌูุจูุง **ูุจู** ุนุฑุถ ุงูู Dialogุ ูููุณ **ุฃุซูุงุก** ุจูุงุฆู. โจ
