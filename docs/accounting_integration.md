# ุชุทุจูู ูุธุงู ุงูุฑุจุท ุงููุญุงุณุจู ูู ุงููููุฏ ุงููุญุงุณุจูุฉ

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุญุฏูุซ ุฏุงูุฉ `add_invoice()` ูู `backend/routes.py` ูุงุณุชุฎุฏุงู **ูุธุงู ุงูุฑุจุท ุงููุญุงุณุจู ุงูุฏููุงูููู** ุจุฏูุงู ูู ุงูุญุณุงุจุงุช ุงูุซุงุจุชุฉ. ุงูุขู ุนูุฏ ุฅูุดุงุก ูุงุชูุฑุฉุ ุณูุชู:

1. **ุฌูุจ ุงูุญุณุงุจุงุช ุงูููุงุณุจุฉ** ูู ุฌุฏูู `AccountingMapping` ุญุณุจ ููุน ุงูุนูููุฉ
2. **ุงุณุชุฎุฏุงู fallback** ููุญุณุงุจุงุช ุงูุงูุชุฑุงุถูุฉ ุฅุฐุง ูู ุชูุฌุฏ ุฅุนุฏุงุฏุงุช ูุฎุตุตุฉ
3. **ุฅูุดุงุก ูููุฏ ูุญุงุณุจูุฉ ุฏูููุฉ** ุชุนูุณ ุงูุฅุนุฏุงุฏุงุช ุงููุญููุธุฉ

---

## ๐ฏ ุงูุชุบููุฑุงุช ุงูุฑุฆูุณูุฉ

### 1๏ธโฃ ููุงุชูุฑ ุงูุจูุน (`ุจูุน`)

**ุงูุญุณุงุจุงุช ุงููุณุชุฎุฏูุฉ:**
```python
cash_acc_id = get_account_id_for_mapping('ุจูุน', 'cash')                    # 15: ุตูุฏูู ุงูููุฏูุฉ
customers_acc_id = get_account_id_for_mapping('ุจูุน', 'customers')          # 5: ุงูุนููุงุก
revenue_acc_id = get_account_id_for_mapping('ุจูุน', 'revenue')              # 55: ูุจูุนุงุช ุฐูุจ ุฌุฏูุฏ
cost_acc_id = get_account_id_for_mapping('ุจูุน', 'cost')                    # 83: ุชูููุฉ ูุจูุนุงุช ุงูุฐูุจ
vat_payable_acc_id = get_account_id_for_mapping('ุจูุน', 'vat_payable')      # 40: ุถ.ู.ู - ุฏุงุฆูุฉ
commission_acc_id = get_account_id_for_mapping('ุจูุน', 'commission')        # 79: ูุตุงุฑูู ุนูููุงุช
commission_vat_acc_id = get_account_id_for_mapping('ุจูุน', 'commission_vat')# 9: ุถ.ู.ู (ูุฏููุฉ)

# ุงููุฎุฒูู ุญุณุจ ุงูุนูุงุฑ
inventory_18k = get_account_id_for_mapping('ุจูุน', 'inventory_18k')         # 25: ูุฎุฒูู ุฐูุจ ุนูุงุฑ 18
inventory_21k = get_account_id_for_mapping('ุจูุน', 'inventory_21k')         # 24: ูุฎุฒูู ุฐูุจ ุนูุงุฑ 21
inventory_22k = get_account_id_for_mapping('ุจูุน', 'inventory_22k')         # 23: ูุฎุฒูู ุฐูุจ ุนูุงุฑ 22
inventory_24k = get_account_id_for_mapping('ุจูุน', 'inventory_24k')         # 22: ูุฎุฒูู ุฐูุจ ุนูุงุฑ 24
```

**ุงููููุฏ ุงููุญุงุณุจูุฉ:**
```
ูู ุญู/ ูุณููุฉ ุงูุฏูุน (ุฃู ุงูุนููุงุก/ุงูุตูุฏูู)        [ูุฏูู]
ูู ุญู/ ูุตุฑูู ุงูุนูููุงุช                          [ูุฏูู] (ุฅู ูุฌุฏุช)
ูู ุญู/ ุถ.ู.ู ุงููุฏููุนุฉ ุนูู ุงูุนูููุงุช             [ูุฏูู] (ุฅู ูุฌุฏุช)
    ุฅูู ุญู/ ุงููุฎุฒูู (ุญุณุจ ุงูุนูุงุฑ)                 [ุฏุงุฆู] - ุงูุชูููุฉ ููุฒุนุฉ
    ุฅูู ุญู/ ุงูุฅูุฑุงุฏุงุช                             [ุฏุงุฆู] - ุงูุฑุจุญ
    ุฅูู ุญู/ ุถ.ู.ู ุงููุณุชุญูุฉ                       [ุฏุงุฆู] (ุฅู ูุฌุฏุช)
```

**ููุฒุงุช ุฌุฏูุฏุฉ:**
- โ ุชูุฒูุน ุงูุชูููุฉ ุนูู ุญุณุงุจุงุช ุงููุฎุฒูู **ุญุณุจ ุงูุนูุงุฑ** (18k, 21k, 22k, 24k)
- โ ุญุณุงุจ ุงูุฅูุฑุงุฏุงุช = ุงููุจูุบ ุงูุฅุฌูุงูู - ุงูุชูููุฉ (ุจุฏูุงู ูู ูุณุจุฉ ุซุงุจุชุฉ 20%)
- โ ููุฏ ูููุตู ูุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ
- โ ุฏุนู **ูุณุงุฆู ุฏูุน ูุชุนุฏุฏุฉ** ูุน ุนูููุงุชูุง ูุถุฑุงุฆุจูุง

---

### 2๏ธโฃ ููุงุชูุฑ ุงูุดุฑุงุก ูู ุงูุนููุงุก (`ุดุฑุงุก ูู ุนููู`)

**ุงูุญุณุงุจุงุช ุงููุณุชุฎุฏูุฉ:**
```python
cash_acc_id = get_account_id_for_mapping('ุดุฑุงุก ูู ุนููู', 'cash')                  # 15
customers_acc_id = get_account_id_for_mapping('ุดุฑุงุก ูู ุนููู', 'customers')        # 5
vat_receivable_acc_id = get_account_id_for_mapping('ุดุฑุงุก ูู ุนููู', 'vat_receivable') # 9
inventory_21k = get_account_id_for_mapping('ุดุฑุงุก ูู ุนููู', 'inventory_21k')       # 24
```

**ุงููููุฏ ุงููุญุงุณุจูุฉ:**
```
ูู ุญู/ ุงููุฎุฒูู                                  [ูุฏูู]
ูู ุญู/ ุถ.ู.ู ุงููุฏููุนุฉ                          [ูุฏูู] (ุฅู ูุฌุฏุช)
    ุฅูู ุญู/ ุงูุนููุงุก (ุฃู ุงูุตูุฏูู)                 [ุฏุงุฆู]
```

---

### 3๏ธโฃ ููุงุชูุฑ ุงูุดุฑุงุก ูู ุงูููุฑุฏูู (`ุดุฑุงุก`)

**ุงูุญุณุงุจุงุช ุงููุณุชุฎุฏูุฉ:**
```python
cash_acc_id = get_account_id_for_mapping('ุดุฑุงุก', 'cash')                    # 15
suppliers_acc_id = get_account_id_for_mapping('ุดุฑุงุก', 'suppliers')          # 38: ุงูููุฑุฏูู
vat_receivable_acc_id = get_account_id_for_mapping('ุดุฑุงุก', 'vat_receivable') # 9
inventory_21k = get_account_id_for_mapping('ุดุฑุงุก', 'inventory_21k')         # 24
```

**ุงููููุฏ ุงููุญุงุณุจูุฉ:**
```
ูู ุญู/ ุงููุฎุฒูู                                  [ูุฏูู]
ูู ุญู/ ุถ.ู.ู ุงููุฏููุนุฉ                          [ูุฏูู] (ุฅู ูุฌุฏุช)
    ุฅูู ุญู/ ุงูููุฑุฏูู (ุฃู ุงูุตูุฏูู)                [ุฏุงุฆู]
```

---

### 4๏ธโฃ ูุฑุชุฌุนุงุช ุงููุจูุนุงุช (`ูุฑุชุฌุน ุจูุน`)

**ุงูุญุณุงุจุงุช ุงููุณุชุฎุฏูุฉ:**
```python
cash_acc_id = get_account_id_for_mapping('ูุฑุชุฌุน ุจูุน', 'cash')                     # 15
customers_acc_id = get_account_id_for_mapping('ูุฑุชุฌุน ุจูุน', 'customers')           # 5
sales_returns_acc_id = get_account_id_for_mapping('ูุฑุชุฌุน ุจูุน', 'sales_returns')   # 54: ูุฑุฏูุฏุงุช ุงููุจูุนุงุช
inventory_21k = get_account_id_for_mapping('ูุฑุชุฌุน ุจูุน', 'inventory_21k')          # 24
```

**ุงููููุฏ ุงููุญุงุณุจูุฉ:**
```
ูู ุญู/ ุงููุฎุฒูู                                  [ูุฏูู] - ุฅุนุงุฏุฉ ุงูุจุถุงุนุฉ
ูู ุญู/ ูุฑุฏูุฏุงุช ุงููุจูุนุงุช                         [ูุฏูู] - ุนูุณ ุงูุฅูุฑุงุฏุงุช
    ุฅูู ุญู/ ุงูุนููุงุก (ุฃู ุงูุตูุฏูู)                 [ุฏุงุฆู] - ุฑุฏ ุงููุจูุบ
```

---

### 5๏ธโฃ ูุฑุชุฌุนุงุช ุงูุดุฑุงุก (`ูุฑุชุฌุน ุดุฑุงุก`)

**ุงูุญุณุงุจุงุช ุงููุณุชุฎุฏูุฉ:**
```python
cash_acc_id = get_account_id_for_mapping('ูุฑุชุฌุน ุดุฑุงุก', 'cash')                       # 15
customers_acc_id = get_account_id_for_mapping('ูุฑุชุฌุน ุดุฑุงุก', 'customers')             # 5
purchase_returns_acc_id = get_account_id_for_mapping('ูุฑุชุฌุน ุดุฑุงุก', 'purchase_returns') # 54
inventory_21k = get_account_id_for_mapping('ูุฑุชุฌุน ุดุฑุงุก', 'inventory_21k')            # 24
```

**ุงููููุฏ ุงููุญุงุณุจูุฉ:**
```
ูู ุญู/ ุงูุนููุงุก (ุฃู ุงูุตูุฏูู)                     [ูุฏูู] - ุงุณุชุฑุฏุงุฏ ุงููุจูุบ
    ุฅูู ุญู/ ุงููุฎุฒูู                              [ุฏุงุฆู] - ุฅุฎุฑุงุฌ ุงูุจุถุงุนุฉ
```

---

## ๐ง ููููุฉ ุนูู ุงููุธุงู

### 1. ุงูุจุญุซ ูู ุงูุฑุจุท ุงููุญุงุณุจู
```python
def get_account_id_for_mapping(operation_type, account_type):
    """
    ูุจุญุซ ุฃููุงู ูู ุฌุฏูู AccountingMapping
    ุซู ูุนูุฏ ููุญุณุงุจุงุช ุงูุงูุชุฑุงุถูุฉ (fallback)
    """
    # 1. ุงูุจุญุซ ูู ุงูุฅุนุฏุงุฏุงุช ุงููุฎุตุตุฉ
    mapping = AccountingMapping.query.filter_by(
        operation_type=operation_type,
        account_type=account_type,
        is_active=True
    ).first()
    
    if mapping:
        return mapping.account_id
    
    # 2. ุงุณุชุฎุฏุงู ุงูุญุณุงุจุงุช ุงูุงูุชุฑุงุถูุฉ
    DEFAULT_ACCOUNTS = {
        'inventory_18k': 25,
        'inventory_21k': 24,
        # ... ุฅูุฎ
    }
    
    return DEFAULT_ACCOUNTS.get(account_type)
```

### 2. ูุซุงู: ููุฏ ูุงุชูุฑุฉ ุจูุน

**ุจูุงูุงุช ุงููุงุชูุฑุฉ:**
- ุฅุฌูุงูู ุงููุงุชูุฑุฉ: 1,000 ุฑ.ุณ
- ุงูุชูููุฉ: 700 ุฑ.ุณ
- ุงูุถุฑูุจุฉ: 150 ุฑ.ุณ
- ุงูุนูููุฉ: 20 ุฑ.ุณ (2%)
- ุถุฑูุจุฉ ุงูุนูููุฉ: 3 ุฑ.ุณ (15%)

**ุงููููุฏ ุงููุญุงุณุจูุฉ ุงูููุดุฃุฉ:**

| ุงูุญุณุงุจ | ุงููุฏูู | ุงูุฏุงุฆู | ุงูููุงุญุธุงุช |
|--------|--------|---------|-----------|
| ุญุณุงุจ ุงูุจูู (ุญุณุจ ูุณููุฉ ุงูุฏูุน) | 977 | - | ุงููุจูุบ ุงูุตุงูู (1000 - 20 - 3) |
| ูุตุฑูู ุงูุนูููุงุช | 20 | - | ุนูููุฉ 2% |
| ุถ.ู.ู ุงููุฏููุนุฉ | 3 | - | 15% ุนูู ุงูุนูููุฉ |
| ูุฎุฒูู ุฐูุจ ุนูุงุฑ 21 | - | 700 | ุงูุชูููุฉ |
| ูุจูุนุงุช ุฐูุจ ุฌุฏูุฏ | - | 150 | ุงูุฑุจุญ (1000 - 700 - 150) |
| ุถ.ู.ู - ุฏุงุฆูุฉ | - | 150 | ุงูุถุฑูุจุฉ |
| **ุงูุฅุฌูุงูู** | **1,000** | **1,000** | โ ูุชูุงุฒู |

---

## ๐จ ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ

### โ 1. ุงููุฑููุฉ ุงููุงููุฉ
- ูููู ุชุบููุฑ ุงูุญุณุงุจุงุช ุงููุณุชุฎุฏูุฉ **ุจุฏูู ุชุนุฏูู ุงูููุฏ**
- ููุท ูู ุฎูุงู ุดุงุดุฉ ุฅุนุฏุงุฏุงุช ุงูุฑุจุท ุงููุญุงุณุจู

### โ 2. ุงูุฏูุฉ ุงููุญุงุณุจูุฉ
- ุชูุฒูุน ุงูุชูููุฉ ุญุณุจ **ุงูุนูุงุฑ ุงููุนูู**
- ุญุณุงุจ ุงูุฑุจุญ = ุงููุจูุบ - ุงูุชูููุฉ (ูููุณ ูุณุจุฉ ุซุงุจุชุฉ)
- ูููุฏ ูููุตูุฉ ููุถุฑุงุฆุจ ูุงูุนูููุงุช

### โ 3. ุฏุนู ูุณุงุฆู ุฏูุน ูุชุนุฏุฏุฉ
- ูููู ุฏูุน ูุงุชูุฑุฉ ูุงุญุฏุฉ ุจุนุฏุฉ ุทุฑู (ููุฏุงู + ูุฏู + ุขุฌู)
- ูู ูุณููุฉ ููุง ุนูููุชูุง ูุถุฑูุจุชูุง ุงููููุตูุฉ
- ููุฏ ูุญุงุณุจู ูููุตู ููู ุฏูุนุฉ

### โ 4. Fallback ุฐูู
- ุฅุฐุง ูู ุชูุฌุฏ ุฅุนุฏุงุฏุงุช ูุฎุตุตุฉุ ูุณุชุฎุฏู ุงูุญุณุงุจุงุช ุงูุงูุชุฑุงุถูุฉ
- ูุง ุชูุฌุฏ ุฃุฎุทุงุก ุญุชู ุจุฏูู ุฅุนุฏุงุฏุงุช

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุฎุทูุงุช ุงูุงุฎุชุจุงุฑ:

1. **ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงูุฅุนุฏุงุฏุงุช:**
```bash
python backend/check_mappings.py
```

2. **ุฅูุดุงุก ูุงุชูุฑุฉ ุจูุน ูู Frontend:**
- ุงูุชุญ ุชุทุจูู Flutter
- ุฃุถู ูุงุชูุฑุฉ ุจูุน ุฌุฏูุฏุฉ
- ุงุญูุธ ุงููุงุชูุฑุฉ

3. **ุงูุชุญูู ูู ุงููููุฏ ุงููุญุงุณุจูุฉ:**
```bash
curl http://localhost:8001/api/journal-entries | jq '.[-1]'
```

4. **ุงูุชุญูู ูู ุงูุชูุงุฒู:**
```sql
SELECT 
    je.id,
    SUM(jel.cash_debit) as total_debit,
    SUM(jel.cash_credit) as total_credit
FROM journal_entries je
JOIN journal_entry_lines jel ON je.id = jel.journal_entry_id
GROUP BY je.id
HAVING ABS(SUM(jel.cash_debit) - SUM(jel.cash_credit)) > 0.01;
```
ูุฌุจ ุฃู ูููู ุงููุงุชุฌ **ูุงุฑุบุงู** (ุฌููุน ุงููููุฏ ูุชูุงุฒูุฉ)

---

## ๐ ููุงุฑูุฉ ูุจู ูุจุนุฏ

### ูุจู (ุญุณุงุจุงุช ุซุงุจุชุฉ):
```python
# โ ุงูุญุณุงุจุงุช ููุชูุจุฉ ูู ุงูููุฏ
inventory_account = Account.query.filter_by(name='ุงููุฎุฒูู').first()
sales_account = Account.query.filter(Account.name.like('ูุจูุนุงุช%')).first()

# โ ูุณุจ ุซุงุจุชุฉ ููุฑุจุญ ูุงูุชูููุฉ
cash_credit=total_cash * 0.8,  # 80% ุชูููุฉ
cash_credit=total_cash * 0.2   # 20% ุฑุจุญ

# โ ูุง ููุฌุฏ ุชูุฑูู ุจูู ุงูุนูุงุฑุงุช
```

### ุจุนุฏ (ุฑุจุท ุฏููุงูููู):
```python
# โ ุงูุญุณุงุจุงุช ุชูุฌูุจ ูู ุงูุฅุนุฏุงุฏุงุช
cash_acc_id = get_account_id_for_mapping('ุจูุน', 'cash')
revenue_acc_id = get_account_id_for_mapping('ุจูุน', 'revenue')

# โ ููู ูุนููุฉ ูู ุงููุงุชูุฑุฉ
total_cost = data.get('total_cost', 0)
total_revenue = total_cash - total_cost

# โ ุชูุฑูู ุจูู ุงูุนูุงุฑุงุช
inventory_21k = get_account_id_for_mapping('ุจูุน', 'inventory_21k')
inventory_22k = get_account_id_for_mapping('ุจูุน', 'inventory_22k')
```

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ูุดููุฉ: ุงูููุฏ ุบูุฑ ูุชูุงุฒู
**ุงูุญู:**
- ุชุญูู ูู ุฃู `total_cost` ู `total_tax` ููุฌูุฏุงู ูู ุจูุงูุงุช ุงููุงุชูุฑุฉ
- ุชุญูู ูู ุงูุฅุนุฏุงุฏุงุช ุงููุญุงุณุจูุฉ: `python backend/check_mappings.py`

### ูุดููุฉ: ูุง ูุชู ุฅูุดุงุก ููุฏ
**ุงูุญู:**
- ุชุญูู ูู ุฃู ุงูุญุณุงุจุงุช ููุฌูุฏุฉ ูู ุฌุฏูู `accounts`
- ุชุญูู ูู logs ุงูุฎุงุฏู: `tail -f backend/server.log`

### ูุดููุฉ: ุฎุทุฃ ูู ุญุณุงุจ ุงูุนูููุฉ
**ุงูุญู:**
- ุชุญูู ูู `commission_rate` ูู ุฌุฏูู `payment_methods`
- ุชุญูู ูู ุฃู `commission_vat` ููุญุณุจ (15%)

---

## ๐ ุงููุฑุงุฌุน

- **ุงูุฑุจุท ุงููุญุงุณุจู**: `docs/accounting_mapping.md`
- **ุงูุชุญูู ูู ุงูุฅุนุฏุงุฏุงุช**: `backend/check_mappings.py`
- **ุงูุญุณุงุจุงุช ุงูุงูุชุฑุงุถูุฉ**: `backend/routes.py` (line 850-890)
- **API ุงูุฑุจุท**: `POST /api/accounting-mappings`

---

## โจ ุงูุฎูุงุตุฉ

ุชู ุชุญุฏูุซ ูุธุงู ุงูููุงุชูุฑ ููููู **ุฏููุงููููุงู ููุฑูุงู** ุจุงููุงูู:

โ 6 ุฃููุงุน ููุงุชูุฑ (ุจูุนุ ุดุฑุงุกุ ุดุฑุงุก ูู ููุฑุฏุ ูุฑุชุฌุน ุจูุนุ ูุฑุชุฌุน ุดุฑุงุกุ ูุฑุชุฌุน ุดุฑุงุก ูู ููุฑุฏ)
โ 15+ ููุน ุญุณุงุจ ูุญุงุณุจู
โ ุฏุนู ุงููุฎุฒูู ุญุณุจ ุงูุนูุงุฑ (18k, 21k, 22k, 24k)
โ ุฏุนู ูุณุงุฆู ุฏูุน ูุชุนุฏุฏุฉ
โ ุญุณุงุจ ุฏููู ููุนูููุงุช ูุงูุถุฑุงุฆุจ
โ ูููุฏ ูุญุงุณุจูุฉ ูุชูุงุฒูุฉ ุฏุงุฆูุงู

**๐ ุงูุขู ูููู ุชุบููุฑ ุฃู ุญุณุงุจ ูู ุงูุฅุนุฏุงุฏุงุช ุฏูู ููุณ ุงูููุฏ!**
