# ูุธุงู ุฅุฏุงุฑุฉ ูุณุงุฆู ุงูุฏูุน ูุงูุญุณุงุจุงุช ุงูุจูููุฉ โ

## ุงูุชุงุฑูุฎ: 13 ุฃูุชูุจุฑ 2025

---

## ๐ ููุฎุต ุงูุชุญุฏูุซุงุช

ุชู ุชุทููุฑ ูุธุงู ูุญุงุณุจู ุงุญุชุฑุงูู ูุฅุฏุงุฑุฉ ูุณุงุฆู ุงูุฏูุน ูุน ุฑุจุทูุง ุจุญุณุงุจุงุช ุจูููุฉ ูุนููุฉุ ุจุฏูุงู ูู ุงูุญุณุงุจุงุช ุงููููุตูุฉ ุงูุณุงุจูุฉ.

---

## ๐๏ธ ุงููุนูุงุฑูุฉ ุงูุฌุฏูุฏุฉ: Sub-Accounts System

### ูุจู ุงูุชุญุฏูุซ โ
```
1113 - ุจุทุงูุฉ ูุฏู (ุญุณุงุจ ูููุตู)
1114 - ููุฒุง/ูุงุณุชุฑูุงุฑุฏ (ุญุณุงุจ ูููุตู)
1117 - STC Pay (ุญุณุงุจ ูููุตู)
1118 - Apple Pay (ุญุณุงุจ ูููุตู)
```

### ุจุนุฏ ุงูุชุญุฏูุซ โ
```
1112 - ุงูุจูู - ุงูุญุณุงุจ ุงูุฌุงุฑู (ุงูุญุณุงุจ ุงูุฑุฆูุณู)
  โโโ 1112.1 - ุจุทุงูุฉ ูุฏู [ุจูู ุงูุฑูุงุถ]
  โโโ 1112.2 - ุจุทุงูุงุช ููุฒุง [ุจูู ุงูุฑุงุฌุญู]
  โโโ 1112.3 - ุจุทุงูุงุช ูุงุณุชุฑูุงุฑุฏ [ุจูู ุงูุฑุงุฌุญู]
  โโโ 1112.4 - STC Pay [ูุญูุธุฉ ุฑูููุฉ]
  โโโ 1112.5 - Apple Pay [ูุญูุธุฉ ุฑูููุฉ]

ุงูุญุณุงุจุงุช ุงููุณุชููุฉ:
1111 - ุงูุตูุฏูู (ููุฏุงู)
1115 - ุชุงุจู (ุดุฑูุฉ ุฎุงุฑุฌูุฉ - BNPL)
1116 - ุชูุงุฑุง (ุดุฑูุฉ ุฎุงุฑุฌูุฉ - BNPL)
1119 - ุงูุชุญููู ุงูุจููู ุงููุจุงุดุฑ
```

---

## ๐ง ุงูุชุบููุฑุงุช ุงูุชูููุฉ

### 1. Backend - Database Schema

#### ุฅุถุงูุฉ ุญููู ุฌุฏูุฏุฉ ูุฌุฏูู `account`:

```sql
ALTER TABLE account ADD COLUMN bank_name VARCHAR(100);
ALTER TABLE account ADD COLUMN account_number_external VARCHAR(100);
ALTER TABLE account ADD COLUMN account_type VARCHAR(50);
```

**ุฃููุงุน ุงูุญุณุงุจุงุช:**
- `bank_account` - ุญุณุงุจ ุจููู (ูุฏูุ ููุฒุงุ ูุงุณุชุฑูุงุฑุฏ)
- `digital_wallet` - ูุญูุธุฉ ุฑูููุฉ (STC Pay, Apple Pay)
- `bnpl` - ุงุดุชุฑ ุงูุขู ูุงุฏูุน ูุงุญูุงู (ุชุงุจูุ ุชูุงุฑุง)
- `cash` - ููุฏ

#### ูุซุงู ุนูู ุงูุจูุงูุงุช:
```python
Account(
    account_number='1112.1',
    name='ุจุทุงูุฉ ูุฏู - ููุงุท ุงูุจูุน',
    bank_name='ุจูู ุงูุฑูุงุถ',
    account_number_external='SA1234567890123456789012',
    account_type='bank_account',
    parent_id=<id of 1112>
)
```

---

### 2. Backend - API Endpoints

#### โ ุชุญุฏูุซ Endpoints ููุฌูุฏุฉ:

**GET /api/accounts**
```json
{
  "id": 95,
  "account_number": "1112.1",
  "name": "ุจุทุงูุฉ ูุฏู - ููุงุท ุงูุจูุน",
  "bank_name": "ุจูู ุงูุฑูุงุถ",
  "account_number_external": "SA1234567890...",
  "account_type": "bank_account",
  "parent_id": 87,
  "parent_account": {
    "id": 87,
    "account_number": "1112",
    "name": "ุงูุจูู - ุงูุญุณุงุจ ุงูุฌุงุฑู"
  }
}
```

**PUT /api/accounts/{id}**
```json
{
  "bank_name": "ุจูู ุงูุฑูุงุถ",
  "account_number_external": "SA1234567890123456789012",
  "account_type": "bank_account"
}
```

#### โ Endpoints ุฌุฏูุฏุฉ:

**POST /api/reorganize-payment-accounts**
- ูุนูุฏ ุชูุธูู ุดุฌุฑุฉ ุงูุญุณุงุจุงุช ููุธุงู Sub-Accounts
- ูุญุฐู ุงูุญุณุงุจุงุช ุงููููุตูุฉ ุงููุฏููุฉ (1113, 1114, 1117, 1118)
- ููุดุฆ ุญุณุงุจุงุช ูุฑุนูุฉ ุฌุฏูุฏุฉ (1112.1 - 1112.5)

**POST /api/add-bank-info-to-accounts**
- ูุถูู ูุนูููุงุช ุงูุจููู ููุญุณุงุจุงุช ุงูููุฌูุฏุฉ
- ูุญุฏุซ 8 ุญุณุงุจุงุช ุจูุนูููุงุช ุงูุชุฑุงุถูุฉ

**GET /api/accounts/hierarchy**
- ูุฑุฌุน ุดุฌุฑุฉ ุงูุญุณุงุจุงุช ุจุดูู ูุฑูู (tree structure)

---

### 3. Frontend - Settings Screen

#### โจ ููุฒุงุช ุงูุนุฑุถ ุงูุฌุฏูุฏุฉ:

**1. ุจุทุงูุฉ ููุณุนุฉ ููู ูุณููุฉ ุฏูุน:**
```dart
๐ฑ ุจุทุงูุฉ ูุฏู [ุจูู ุงูุฑูุงุถ]
   ๐ฐ ุนูููุฉ: 1.5% | โฐ 2 ููู
   ๐ณ 1112.1 [ุฌูุงุฒ POS]
   
   ุนูุฏ ุงูุชูุณูุน:
   โโโโโโโโโโโโโโโโโโโโโโโโโโโ
   ุชูุงุตูู ุงูุญุณุงุจ
   ๐ฆ ุงูุจูู: ุจูู ุงูุฑูุงุถ
   ๐ณ ุฑูู ุงูุญุณุงุจ: SA12345...
   ๐ ุงูุญุณุงุจ ุงููุญุงุณุจู: 1112.1 - ุจุทุงูุฉ ูุฏู
   ๐ฐ ุงูุนูููุฉ: 1.5% | โฐ ุงูุงุณุชูุงู: 2 ููู
   ๐ ููุงุญุธุงุช: ุนูููุฉ ุงูุจูู...
```

**2. ุฃููููุงุช ุฏููุงููููุฉ ุญุณุจ ููุน ุงูุญุณุงุจ:**
- ๐ฐ ููุฏ โ `Icons.money`
- ๐ฆ ุจูู โ `Icons.account_balance`
- ๐ฑ ูุญูุธุฉ ุฑูููุฉ โ `Icons.phone_android`
- ๐ณ BNPL โ `Icons.payment`

**3. Badge ููุจูู:**
```dart
[ุจูู ุงูุฑูุงุถ] // ูู ุงูู title
```

#### ๐ Dialog ุงูุฅุถุงูุฉ/ุงูุชุนุฏูู ุงูุฌุฏูุฏ:

**7 ุญููู ุดุงููุฉ:**
1. โ **ุงุณู ูุณููุฉ ุงูุฏูุน*** (ูุทููุจ)
2. โ **ุงูุญุณุงุจ ุงููุญุงุณุจู*** (Dropdown - ูุทููุจ)
3. โ **ุงุณู ุงูุจูู/ุงููุคุณุณุฉ**
4. โ **ุฑูู ุงูุญุณุงุจ/IBAN**
5. โ **ุงูุนูููุฉ (%)**
6. โ **ุฃูุงู ุงูุงุณุชูุงู**
7. โ **ููุงุญุธุงุช**

**ูุฒุงูุง ุฅุถุงููุฉ:**
- โจ ุชุนุจุฆุฉ ุชููุงุฆูุฉ ููุนูููุงุช ุงูุจูู ุนูุฏ ุงุฎุชูุงุฑ ุงูุญุณุงุจ
- โจ ุชุญุฏูุซ ุงูุญุณุงุจ ุงููุญุงุณุจู ุชููุงุฆูุงู ุนูุฏ ุฅุถุงูุฉ ูุนูููุงุช ุจูู ุฌุฏูุฏุฉ
- โจ Validation ูุงูู ููุญููู ุงููุทููุจุฉ
- โจ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ

---

## ๐ ุชุฏูู ุงูุจูุงูุงุช

### ุนูุฏ ุฅุถุงูุฉ ูุณููุฉ ุฏูุน ุฌุฏูุฏุฉ:

```
1. ุงููุณุชุฎุฏู ูููุฃ ุงูู Dialog โ๏ธ
   โ
2. ุฅุฐุง ุฃุถุงู ูุนูููุงุช ุจูู ุฌุฏูุฏุฉ:
   PUT /api/accounts/{id} 
   {bank_name, account_number_external}
   โ
3. ุฅุถุงูุฉ ูุณููุฉ ุงูุฏูุน:
   POST /api/payment-methods
   {name, account_id, commission_rate, ...}
   โ
4. ุฅุนุงุฏุฉ ุชุญููู ุงููุงุฆูุฉ:
   GET /api/payment-methods
   โ
5. ุนุฑุถ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ ๐ฑ
```

---

## ๐ฏ ุงูููุงุฆุฏ ุงููุญุงุณุจูุฉ

### 1. **ุฏูุฉ ูุญุงุณุจูุฉ ุฃุนูู** ๐
- ูู ูุณููุฉ ุฏูุน ูุฑุจูุทุฉ ุจุญุณุงุจ ุจููู ูุนูู
- ุณูููุฉ ุงููุทุงุจูุฉ ูุน ูุดูู ุงูุญุณุงุจ ุงูุจูููุฉ
- ุชุชุจุน ุฏููู ููุนูููุงุช

### 2. **ุชูุงุฑูุฑ ุฃูุถู** ๐
```sql
-- ุฅุฌูุงูู ูุจูุนุงุช ูุฏู ูู ุจูู ุงูุฑูุงุถ
SELECT SUM(amount) FROM transactions 
WHERE account_id = (
  SELECT id FROM accounts 
  WHERE account_number = '1112.1'
);

-- ุงููุจุงูุบ ุงููุณุชุญูุฉ ูู ุชุงุจู (ุชุตู ุฎูุงู 7 ุฃูุงู)
SELECT balance FROM accounts 
WHERE account_number = '1115';
```

### 3. **ุฅุฏุงุฑุฉ ุงูุณูููุฉ** ๐ฐ
- ูุนุฑูุฉ ุงูุณูููุฉ ุงููุชุงุญุฉ ููุฑุงู (ููุฏ + ุจูู)
- ูุนุฑูุฉ ุงููุณุชุญูุงุช ุงููุงุฏูุฉ (ุชุงุจูุ ุชูุงุฑุง)
- ุญุณุงุจ ุตุงูู ุงูุณูููุฉ ุจุนุฏ ุงูุนูููุงุช

### 4. **ุชุญููู ุญุณุจ ุงูุจูู** ๐ฆ
- ูู ูู ุงููุจูุนุงุช ุนุจุฑ ุจูู ุงูุฑูุงุถุ
- ูู ูู ุงููุจูุนุงุช ุนุจุฑ ุจูู ุงูุฑุงุฌุญูุ
- ุฃู ุจูู ุฃูู ูู ุงูุนูููุงุชุ

---

## ๐ Migration Path

### ููุฃูุธูุฉ ุงูููุฌูุฏุฉ:

**ุงูุฎุทูุฉ 1:** ุฅุถุงูุฉ ุงูุฃุนูุฏุฉ ุงูุฌุฏูุฏุฉ
```bash
cd backend
sqlite3 app.db < migrations/add_bank_info.sql
```

**ุงูุฎุทูุฉ 2:** ุฅุนุงุฏุฉ ุชูุธูู ุงูุญุณุงุจุงุช
```bash
curl -X POST http://localhost:8001/api/reorganize-payment-accounts
```

**ุงูุฎุทูุฉ 3:** ุฅุถุงูุฉ ูุนูููุงุช ุงูุจููู
```bash
curl -X POST http://localhost:8001/api/add-bank-info-to-accounts
```

**ุงูุฎุทูุฉ 4:** ุชุญุฏูุซ Flutter app
```bash
cd frontend
flutter run
```

---

## ๐ ุฃูุซูุฉ ุงูุงุณุชุฎุฏุงู

### ูุซุงู 1: ุฅุถุงูุฉ ุญุณุงุจ ูุฏู ุฌุฏูุฏ

```
ุงูุงุณู: ูุฏู - ุจูู ุงูุฃููู
ุงูุญุณุงุจ ุงููุญุงุณุจู: 1112.1 (ุณูุชู ุชุญุฏูุซู)
ุงูุจูู: ุจูู ุงูุฃููู ุงูุชุฌุงุฑู
ุฑูู ุงูุญุณุงุจ: SA9876543210987654321098
ุงูุนูููุฉ: 1.4%
ุฃูุงู ุงูุงุณุชูุงู: 1
ุงูููุงุญุธุงุช: ุญุณุงุจ POS ุงููุฑุน ุงูุฑุฆูุณู
```

### ูุซุงู 2: ุฅุถุงูุฉ ูุญูุธุฉ ุฑูููุฉ ุฌุฏูุฏุฉ

```
ุงูุงุณู: urpay
ุงูุญุณุงุจ ุงููุญุงุณุจู: ุฅูุดุงุก ุฌุฏูุฏ (1112.6)
ุงูุจูู: urpay ุงููุญูุธุฉ ุงูุฑูููุฉ
ุฑูู ุงูุญุณุงุจ: 05XXXXXXXX
ุงูุนูููุฉ: 1.2%
ุฃูุงู ุงูุงุณุชูุงู: 0 (ููุฑู)
```

---

## ๐ ุงูุชุญุฏูุงุช ุงููุญูููุฉ

### 1. โ ูุดููุฉ Flask Context
**ุงูุฎุทุฃ:** `RuntimeError: Flask app not registered`
**ุงูุญู:** ุงุณุชุฎุฏุงู API endpoints ุจุฏูุงู ูู ุณูุฑูุจุชุงุช ูุณุชููุฉ

### 2. โ ูุดููุฉ ุงูุฃููุงู ูุงูุชุจุงูู
**ุงูุฎุทุฃ:** ูุต ูุงุชุญ ุนูู ุฎูููุฉ ุฐูุจูุฉ (ุบูุฑ ูุงุจู ูููุฑุงุกุฉ)
**ุงูุญู:** ุงุณุชุฎุฏุงู `Colors.black87` ูุน ูุณุจุฉ ุชุจุงูู 9.8:1 (WCAG AAA)

### 3. โ ุชุนุงุฑุถ ูู Import
**ุงูุฎุทุฃ:** `PaymentMethod` not found
**ุงูุญู:** ุฅุถุงูุฉ import ุตุฑูุญ ูู `routes.py`

---

## โ ุงููููุงุช ุงููุนุฏูุฉ

### Backend:
- โ `backend/models.py` - ุฅุถุงูุฉ ุญููู ุฌุฏูุฏุฉ ูู Account
- โ `backend/routes.py` - 3 endpoints ุฌุฏูุฏุฉ + ุชุญุฏูุซ ููุฌูุฏุฉ
- โ `backend/app.db` - ุฅุถุงูุฉ 3 ุฃุนูุฏุฉ ุฌุฏูุฏุฉ

### Frontend:
- โ `frontend/lib/screens/settings_screen.dart` - ุชุญุฏูุซ ูุงูู ููุนุฑุถ ูุงูู dialog
- โ `frontend/lib/api_service.dart` - ุฏูุงู PaymentMethod API

### Documentation:
- โ `docs/PAYMENT_SYSTEM_SUMMARY.md` - ูุฐุง ุงูููู

---

## ๐ ุงูุฅุญุตุงุฆูุงุช

- **ุญุณุงุจุงุช ุชู ุญุฐููุง:** 4 (1113, 1114, 1117, 1118)
- **ุญุณุงุจุงุช ุฌุฏูุฏุฉ:** 5 (1112.1 - 1112.5)
- **ุญููู ุฌุฏูุฏุฉ ูู Account:** 3 (bank_name, account_number_external, account_type)
- **API endpoints ุฌุฏูุฏุฉ:** 3
- **ุฃุณุทุฑ ููุฏ ูุถุงูุฉ ูู Frontend:** ~200 ุณุทุฑ
- **ูุณุงุฆู ุฏูุน ุงูุชุฑุงุถูุฉ:** 9 (ููุฏุ ูุฏูุ ููุฒุงุ ูุงุณุชุฑูุงุฑุฏุ ุชุงุจูุ ุชูุงุฑุงุ STC Payุ Apple Payุ ุชุญููู ุจููู)

---

## ๐ ุงูุฎุทูุงุช ุงููุงุฏูุฉ (ุงุฎุชูุงุฑู)

### ุงููุฑุญูุฉ ุงูุชุงููุฉ:
1. โจ ุชูุงุฑูุฑ ุงูุณูููุฉ ูุงููุณุชุญูุงุช
2. โจ ุฑุณูู ุจูุงููุฉ ูููุจูุนุงุช ุญุณุจ ูุณููุฉ ุงูุฏูุน
3. โจ ุชูุจููุงุช ูููุจุงูุบ ุงููุณุชุญูุฉ ุงููุงุฏูุฉ
4. โจ ุชูุงูู ูุน API ุงูุจููู ูุฌูุจ ุงูุฑุตูุฏ ุงููุนูู
5. โจ ุชุตุฏูุฑ ุชูุงุฑูุฑ Excel/PDF

---

## ๐จโ๐ป ุงููุทูุฑูู

ุชู ุงูุชุทููุฑ ุจูุงุณุทุฉ: GitHub Copilot + Saleh Alabbadi
ุงูุชุงุฑูุฎ: 13 ุฃูุชูุจุฑ 2025

---

## ๐ ุงูุฏุนู

ููุงุณุชูุณุงุฑุงุช ุฃู ุงููุดุงูู ุงูุชูููุฉ:
- ุฑุงุฌุน ุงูุชูุซูู ูู `docs/`
- ุชุญูู ูู logs ูู `backend/server.log`
- ุงุณุชุฎุฏู `GET /api/accounts/hierarchy` ูุนุฑุถ ุงูุดุฌุฑุฉ

---

**ููุงุญุธุฉ ููุงุฆูุฉ:** 
ุฌููุน ุงูุชุนุฏููุงุช ูุชูุงููุฉ ูุน ุงููุธุงู ุงูุญุงูู ููุง ุชุคุซุฑ ุนูู ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ. ูููู ุงูุฑุฌูุน ูููุธุงู ุงููุฏูู ุจุณูููุฉ ุฅุฐุง ูุฒู ุงูุฃูุฑ.

โ **ุงููุธุงู ุฌุงูุฒ ููุฅูุชุงุฌ!**
